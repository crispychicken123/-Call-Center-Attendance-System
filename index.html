<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Master v6.1 (Enterprise Enhanced)</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Excel Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #ef4444;
            --success: #10b981;
            --warning: #f59e0b; 
            --danger: #991b1b;
            --bg-body: #f3f4f6;
            --surface: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        body.dark-mode {
            --primary: #60a5fa;
            --primary-dark: #3b82f6;
            --bg-body: #0f172a;
            --surface: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }

        /* Arabic Font override */
        body.rtl-mode { font-family: 'Cairo', sans-serif; }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            transition: var(--transition);
            overflow: hidden;
        }

        body.locked-screen {
            pointer-events: none;
            filter: blur(5px);
        }

        /* Enhanced Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            background: var(--surface);
            padding: 30px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow-lg);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alert Banner */
        #globalAlerts {
            display: none;
            background: #fffbeb;
            border-bottom: 1px solid #fcd34d;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #92400e;
        }
        #globalAlerts.active { display: flex; }
        .alert-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.5);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; height: auto; overflow: visible; display: none !important; }
            
            #printContainer, #printContainer * { 
                visibility: visible !important; 
                display: block !important; 
            }
            
            #printContainer {
                position: static !important;
                left: 0 !important; 
                top: 0 !important; 
                width: 100% !important; 
                z-index: 9999; 
                background: white; 
                padding: 20px; 
                color: black;
                height: auto !important;
                overflow: visible !important;
            }

            table.print-table {
                width: 100% !important;
                border-collapse: collapse;
                border-spacing: 0;
                font-size: 12px;
            }
            
            th.print-th, td.print-td {
                border: 1px solid #000 !important; 
                color: black !important;
                padding: 8px !important;
                text-align: left !important;
                vertical-align: middle !important;
                position: static !important;
                background: white !important;
            }

            .no-print { display: none !important; }
        }

        /* Lock Screen Modal */
        #lockScreenModal {
            z-index: 3000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .pin-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-width: 300px;
            margin: 0 auto;
        }
        .pin-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-main);
            font-size: 24px;
            font-weight: 700;
            padding: 20px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
        }
        .pin-btn:hover {
            background: var(--bg-body);
            transform: scale(1.1);
        }
        .pin-display {
            background: var(--bg-body);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 24px;
            letter-spacing: 10px;
            text-align: center;
            font-family: monospace;
        }

        /* Header */
        header { 
            background: rgba(255, 255, 255, 0.8); 
            backdrop-filter: blur(10px); 
            border-bottom: 1px solid var(--border); 
            padding: 0 24px; 
            height: 70px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            position: sticky; 
            top: 0; 
            z-index: 50;
            box-shadow: var(--shadow);
            flex-shrink: 0;
        }
        body.dark-mode header { background: rgba(30, 41, 59, 0.8); }
        
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand i { color: var(--primary); font-size: 24px; }
        .brand h1 { font-size: 20px; font-weight: 700; color: var(--text-main); }
        .brand span { font-size: 11px; background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-left: 5px;}

        .controls { display: flex; align-items: center; gap: 15px; }
        .btn-icon { 
            background: transparent; 
            border: 1px solid var(--border); 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            color: var(--text-muted); 
            transition: var(--transition);
        }
        .btn-icon:hover { background: var(--bg-body); color: var(--primary); transform: translateY(-2px); }

        /* System Menu */
        .system-menu { position: relative; }
        .sys-btn { 
            background: var(--surface); 
            border: 1px solid var(--border); 
            padding: 8px 12px; 
            border-radius: 8px; 
            font-size: 13px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            color: var(--text-main);
            transition: var(--transition);
        }
        .sys-btn:hover { background: var(--bg-body); }
        .sys-dropdown { 
            position: absolute; 
            top: 100%; 
            right: 0; 
            background: var(--surface); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            width: 260px; 
            box-shadow: var(--shadow-lg); 
            display: none; 
            flex-direction: column; 
            padding: 5px; 
            margin-top: 5px; 
            z-index: 60;
            animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sys-dropdown.show { display: flex; }
        .sys-item { 
            padding: 10px; 
            font-size: 13px; 
            cursor: pointer; 
            border-radius: 4px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            color: var(--text-main);
            transition: var(--transition);
        }
        .sys-item:hover { background: var(--bg-body); }
        .sys-item i { width: 20px; text-align: center; color: var(--text-muted); }
        .sys-item.danger { color: var(--danger); }
        .sys-item.danger i { color: var(--danger); }
        .sys-separator { height: 1px; background: var(--border); margin: 5px 0; width: 100%; }

        /* Language Toggle Button */
        .lang-btn {
            background: var(--surface);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
        }
        .lang-btn:hover {
            background: var(--primary);
            color: white;
        }

        main { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            gap: 20px; 
            overflow: hidden; 
            max-width: 1900px; 
            margin: 0 auto; 
            width: 100%;
            position: relative;
        }
        
        .tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            flex-wrap: wrap;
        }
        .tab-btn { 
            padding: 8px 20px; 
            border: none; 
            background: var(--surface); 
            color: var(--text-muted); 
            font-weight: 600; 
            border-radius: 8px; 
            cursor: pointer; 
            border: 1px solid var(--border); 
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tab-btn.active { 
            background: var(--primary); 
            color: white; 
            border-color: var(--primary);
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
        }
        .tab-btn:hover:not(.active) { 
            background: var(--bg-body); 
            transform: translateY(-2px);
        }

        .view-section { 
            display: none; 
            flex-direction: column; 
            gap: 20px; 
            height: 100%;
            animation: fadeIn 0.3s ease-out;
            flex: 1;
            overflow: hidden;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .view-section.active { display: flex; }

        .toolbar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: var(--surface); 
            padding: 16px 20px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow); 
            flex-wrap: wrap; 
            gap: 15px; 
            border: 1px solid var(--border);
            transition: var(--transition);
            flex-shrink: 0;
        }
        .toolbar:hover { box-shadow: var(--shadow-lg); }
        .search-wrapper { 
            position: relative; 
            width: 300px; 
        }
        .search-wrapper i { 
            position: absolute; 
            left: 12px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--text-muted); 
        }
        body.rtl-mode .search-wrapper i { left: auto; right: 12px; }
        body.rtl-mode .search-input { padding: 10px 38px 10px 12px; }

        .search-input { 
            width: 100%; 
            padding: 10px 10px 10px 38px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            background: var(--bg-body); 
            color: var(--text-main); 
            font-family: inherit;
            transition: var(--transition);
        }
        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .actions { 
            display: flex; 
            gap: 10px; 
            flex-shrink: 0;
            flex-wrap: wrap;
        }
        body.rtl-mode .actions { flex-direction: row-reverse; }
        
        .btn { 
            padding: 10px 18px; 
            border-radius: 8px; 
            border: none; 
            font-size: 13px; 
            font-weight: 600; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            color: white; 
            transition: var(--transition);
            box-shadow: var(--shadow);
            white-space: nowrap;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 6px 8px -1px rgba(59, 130, 246, 0.3); }
        .btn-secondary { 
            background: var(--surface); 
            color: var(--text-main); 
            border: 1px solid var(--border);
        }
        .btn-secondary:hover { background: var(--bg-body); transform: translateY(-2px); }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--secondary); }
        .btn-info { background: #8b5cf6; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 10px;
        }
        .pagination button {
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-main);
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
        }
        .pagination button:hover:not(:disabled) {
            background: var(--bg-body);
            transform: translateY(-2px);
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .pagination-info {
            font-size: 13px;
            color: var(--text-muted);
        }

        .table-wrapper { 
            flex: 1; 
            background: var(--surface); 
            border-radius: var(--radius); 
            box-shadow: var(--shadow-lg); 
            overflow: auto; 
            position: relative; 
            border: 1px solid var(--border);
            transition: var(--transition);
            min-height: 200px;
        }
        .table-wrapper:hover { box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.15); }
        
        table { 
            border-collapse: separate; 
            border-spacing: 0; 
            width: 100%; 
            min-width: 1200px; 
        }
        th, td { 
            padding: 12px; 
            text-align: center; 
            border-bottom: 1px solid var(--border); 
            border-right: 1px solid var(--border); 
            font-size: 13px; 
            vertical-align: middle;
            transition: var(--transition);
        }
        
        .thead th { 
            background: var(--bg-body); 
            color: var(--text-muted); 
            font-weight: 700; 
            text-transform: uppercase; 
            font-size: 11px; 
            position: sticky; 
            top: 0; 
            z-index: 20; 
            border-bottom: 2px solid var(--border);
            left: 0;
        }
        
        th:first-child, td:first-child { 
            position: sticky; 
            left: 0; 
            z-index: 10; 
            background: var(--surface); 
            text-align: left; 
            min-width: 220px; 
            padding-left: 20px; 
            border-right: 2px solid var(--border); 
        }

        .summary-table th { background: #f8fafc; font-weight: 600; border: 1px solid #ccc; }
        .summary-table td { border: 1px solid #ccc; padding: 8px; }
        .arabic-header { 
            font-size: 16px; 
            font-weight: 700; 
            color: #333; 
            text-align: center; 
            margin-bottom: 10px;
            background: white;
            padding: 10px;
            border: 1px solid #eee;
        }

        .emp-cell { 
            display: flex; 
            align-items: center; 
            gap: 14px; 
            cursor: pointer; 
            transition: var(--transition); 
            border-radius: 6px; 
            padding: 4px;
        }
        .emp-cell:hover { 
            background-color: rgba(59, 130, 246, 0.1); 
            transform: translateX(4px);
        }
        .emp-avatar { 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 2px solid var(--surface); 
            box-shadow: 0 0 0 1px var(--border);
        }
        .emp-info { 
            display: flex; 
            flex-direction: column; 
        }
        .emp-name { 
            font-weight: 600; 
            color: var(--text-main); 
            font-size: 14px; 
        }
        .emp-meta { 
            font-size: 11px; 
            color: var(--text-muted); 
            margin-top: 2px; 
        }

        .shift-cell { 
            cursor: pointer; 
            transition: 0.1s; 
            user-select: none; 
            font-size: 12px; 
            line-height: 1.4; 
        }
        .shift-cell:hover { 
            background-color: rgba(59, 130, 246, 0.1); 
        }
        .off-day { 
            background-color: #f3f4f6; 
            color: var(--text-muted); 
            font-style: italic; 
            letter-spacing: 1px; 
        }
        .shift-time { 
            display: block; 
            font-weight: 600; 
            color: var(--text-main); 
        }
        .split-sep { 
            color: var(--primary); 
            font-size: 10px; 
            margin: 2px 0; 
            display: block; 
        }

        .status-badge { 
            padding: 4px 10px; 
            border-radius: 20px; 
            font-size: 11px; 
            font-weight: 700; 
            text-transform: uppercase; 
            display: inline-block;
            transition: var(--transition);
        }
        .status-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-pending { 
            background: #fef3c7; 
            color: #92400e; 
        }
        .status-approved { 
            background: #dcfce7; 
            color: #166534; 
        }
        .status-rejected { 
            background: #fee2e2; 
            color: #991b1b; 
        }

        /* Enhanced Modals */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(5px); 
            z-index: 2000; 
            align-items: center; 
            justify-content: center; 
            opacity: 0; 
            transition: opacity 0.3s ease-out;
        }
        .modal.active { 
            display: flex; 
            opacity: 1;
        }
        .modal-card { 
            background: var(--surface); 
            width: 90%; 
            max-width: 600px; 
            border-radius: 16px; 
            padding: 0; 
            box-shadow: var(--shadow-lg); 
            transform: scale(0.95); 
            transition: transform 0.3s ease-out;
            max-height: 90vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
        }
        .modal.active .modal-card { 
            transform: scale(1); 
        }
        .modal-header { 
            padding: 20px 24px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: var(--bg-body);
        }
        .modal-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: var(--text-main); 
        }
        .close-modal { 
            background: none; 
            border: none; 
            font-size: 20px; 
            cursor: pointer; 
            color: var(--text-muted); 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: var(--transition);
        }
        .close-modal:hover { 
            background: var(--border); 
            transform: rotate(90deg);
        }
        .modal-body { 
            padding: 24px; 
            overflow-y: auto;
        }
        .modal-footer { 
            padding: 20px 24px; 
            border-top: 1px solid var(--border); 
            display: flex; 
            justify-content: flex-end; 
            gap: 12px; 
            background: var(--bg-body);
        }
        
        .form-group { 
            margin-bottom: 15px; 
        }
        .form-label { 
            display: block; 
            font-size: 12px; 
            font-weight: 600; 
            color: var(--text-muted); 
            margin-bottom: 6px; 
        }
        .required::after { 
            content: " *"; 
            color: var(--secondary); 
        }
        .form-input, .form-select, .form-textarea { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            font-family: inherit; 
            font-size: 13px; 
            background: var(--bg-body); 
            color: var(--text-main);
            transition: var(--transition);
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        .form-textarea { 
            resize: vertical; 
            min-height: 80px; 
        }
        .form-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
        }
        .time-group { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            align-items: center; 
            background: var(--bg-body); 
            padding: 10px; 
            border-radius: 8px; 
            border: 1px solid var(--border);
        }

        /* Toast Notifications */
        .toast { 
            position: fixed; 
            bottom: 24px; 
            right: 24px; 
            background: #1f2937; 
            color: white; 
            padding: 14px 24px; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 500; 
            transform: translateY(100px); 
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            z-index: 2500;
            box-shadow: var(--shadow-lg); 
            display: flex; 
            align-items: center; 
            gap: 12px;
            max-width: 350px;
            border-left: 4px solid var(--success);
        }
        .toast.show { 
            transform: translateY(0); 
        }
        .toast.success { 
            border-left-color: var(--success); 
        }
        .toast.error { 
            border-left-color: var(--secondary); 
        }
        .toast.info {
            border-left-color: var(--primary);
        }

        /* Charts Container */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-main);
        }
        
        /* System Log Table */
        .log-table { font-family: 'Courier New', monospace; font-size: 11px; }
        .log-entry-error { color: var(--danger); }
        .log-entry-warn { color: var(--warning); }
        .log-entry-info { color: var(--primary); }

        /* Roadmap */
        .roadmap-list { display: flex; flex-direction: column; gap: 15px; }
        .roadmap-item { display: flex; gap: 15px; align-items: flex-start; }
        .roadmap-status { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-top: 5px; }
        .roadmap-status.done { background: var(--success); }
        .roadmap-status.pending { background: var(--warning); }
        .roadmap-status.future { background: var(--text-muted); }
        .roadmap-content h4 { font-size: 14px; margin-bottom: 5px; color: var(--text-main); }
        .roadmap-content p { font-size: 12px; color: var(--text-muted); }

        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                padding: 0 10px;
            }
            
            .brand h1 {
                font-size: 16px;
            }
            
            .controls {
                gap: 8px;
            }
            
            .btn-icon {
                width: 32px;
                height: 32px;
            }
            
            main {
                padding: 10px;
            }
            
            .tabs {
                gap: 5px;
            }
            
            .tab-btn {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .toolbar {
                padding: 12px;
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-wrapper {
                width: 100%;
            }
            
            .actions {
                justify-content: center;
            }
            
            .table-wrapper {
                border-radius: 8px;
            }
            
            th, td {
                padding: 8px;
                font-size: 12px;
            }
            
            .modal-card {
                width: 95%;
                margin: 10px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animation Classes */
        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* Performance Optimization */
        .lazy-load {
            opacity: 0;
            transition: opacity 0.3s;
        }

        .lazy-load.loaded {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Enhanced Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p id="loadingMessage">Loading...</p>
        </div>
    </div>

    <!-- Alert Banner -->
    <div id="globalAlerts" class="no-print">
        <!-- Dynamic Alerts injected by JS -->
    </div>

    <!-- Lock Screen (Hidden by default) -->
    <div id="lockScreenModal" class="modal no-print">
        <div class="modal-card" style="text-align: center; padding-top: 50px; background: white; color: #333;">
            <h2 style="margin-bottom: 30px; color: var(--secondary);"><i class="fas fa-lock"></i> System Locked</h2>
            <p style="margin-bottom: 20px; color: #666;">Enter PIN to unlock</p>
            <div class="pin-display" id="pinDisplay">****</div>
            <div class="pin-pad" id="pinPad">
                <!-- 1-9 generated by JS -->
            </div>
            <p style="margin-top: 20px; font-size: 12px; color: #999;">Default PIN: 0000</p>
            <button class="btn btn-secondary" onclick="app.unlockSystem('0000')" style="margin-top: 10px; width: 100%;">Unlock with Default PIN</button>
        </div>
    </div>

    <!-- Header -->
    <header class="no-print">
        <div class="brand">
            <i class="fas fa-calendar-check"></i>
            <div>
                <h1>HR Master <span>v6.1</span></h1>
                <span style="font-size: 12px; color: var(--text-muted); font-weight: 500;">Enterprise Enhanced</span>
            </div>
        </div>
        <div class="controls">
            <!-- Lock Button -->
            <button class="btn-icon" onclick="app.showLockScreen()" title="Lock System">
                <i class="fas fa-lock"></i>
            </button>

            <!-- Language Toggle -->
            <button class="lang-btn" onclick="app.toggleLanguage()" id="langBtn">
                <span id="langText">EN</span>
            </button>

            <!-- System Menu -->
            <div class="system-menu">
                <button class="sys-btn" onclick="app.toggleSystemMenu()">
                    <i class="fas fa-cog"></i> <i class="fas fa-ellipsis-v no-print"></i>
                </button>
                <div class="sys-dropdown" id="sysDropdown">
                    <div class="sys-item" onclick="app.openSystemInfo()">
                        <i class="fas fa-info-circle"></i> <span data-i18n="menu_system_info">System Info & Roadmap</span>
                    </div>
                    <div class="sys-item" onclick="app.openLogs()">
                        <i class="fas fa-history"></i> <span data-i18n="menu_system_logs">System Logs</span>
                    </div>
                    <div class="sys-item" onclick="app.openBackupManager()">
                        <i class="fas fa-database"></i> <span data-i18n="menu_backup_manager">Backup Manager</span>
                    </div>
                    <div class="sys-separator"></div>
                    <div class="sys-item" onclick="app.downloadBackup()">
                        <i class="fas fa-download"></i> <span data-i18n="menu_backup">Download Backup</span>
                    </div>
                    <label class="sys-item">
                        <i class="fas fa-file-upload"></i> <span data-i18n="menu_import">Import CSV Staff</span>
                        <input type="file" id="importFile" accept=".csv" style="display:none;" onchange="app.importCSV(this)">
                    </label>
                    <label class="sys-item">
                        <i class="fas fa-upload"></i> <span data-i18n="menu_restore">Restore Backup (JSON)</span>
                        <input type="file" id="restoreFile" accept=".json" style="display:none;" onchange="app.restoreBackup(this)">
                    </label>
                    <div class="sys-separator"></div>
                    <div class="sys-item danger" onclick="app.resetSystem()">
                        <i class="fas fa-trash"></i> <span data-i18n="menu_reset">Reset All Data</span>
                    </div>
                </div>
            </div>

            <button class="btn-icon" onclick="app.toggleTheme()" title="Toggle Dark Mode">
                <i class="fas fa-moon" id="themeIcon"></i>
            </button>
            <div style="font-family: 'Courier New', monospace; font-weight: 700; background: var(--text-main); color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 14px;" id="clock">00:00</div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="no-print">
        
        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab-btn" onclick="app.switchTab('attendance')" id="btn-tab-attendance">
                <i class="fas fa-calendar-day"></i> <span data-i18n="tab_attendance">Attendance Log</span>
            </button>
            <button class="tab-btn" onclick="app.switchTab('schedule')" id="btn-tab-schedule">
                <i class="fas fa-clock"></i> <span data-i18n="tab_schedule">Schedule</span>
            </button>
            <button class="tab-btn" onclick="app.switchTab('requests')" id="btn-tab-requests">
                <i class="fas fa-plane-departure"></i> <span data-i18n="tab_requests">Leave Requests</span>
            </button>
            <button class="tab-btn" onclick="app.switchTab('summary')" id="btn-tab-summary">
                <i class="fas fa-chart-pie"></i> <span data-i18n="tab_summary">Summary Report</span>
            </button>
        </div>

        <!-- VIEW: ATTENDANCE -->
        <div id="view-attendance" class="view-section">
            <div class="toolbar">
                <div style="display: flex; gap: 20px; align-items: center; width: 100%;">
                    <div class="search-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" class="search-input" placeholder="Search employee..." data-i18n-ph="search_emp">
                    </div>
                    <div style="flex:1;"></div>
                    <div class="actions">
                        <button class="btn btn-warning" onclick="app.openOTModal()">
                            <i class="fas fa-clock"></i> <span data-i18n="btn_edit_ot">Edit OT</span>
                        </button>
                        <button class="btn btn-secondary" onclick="app.openBulkModal()">
                            <i class="fas fa-calendar-alt"></i> <span data-i18n="btn_bulk">Bulk</span>
                        </button>
                        <button class="btn btn-primary" onclick="app.openEmployeeModal()">
                            <i class="fas fa-user-plus"></i> <span data-i18n="btn_add_emp">Add Emp</span>
                        </button>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:10px; align-items:center; margin-bottom:-10px; padding:0 5px;">
                <label style="font-size:12px; font-weight:600; color:var(--text-muted);" data-i18n="lbl_month">Month:</label>
                <select id="monthSelect" style="padding: 4px 12px; border: 1px solid var(--border); border-radius: 6px;"></select>
                <select id="yearSelect" style="padding: 4px 12px; border: 1px solid var(--border); border-radius: 6px;"></select>
            </div>

            <div class="table-wrapper">
                <table id="attendanceTable">
                    <thead>
                        <tr id="tableHeader">
                            <th data-i18n="col_emp_details">Employee Details</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination" id="attendancePagination">
                <button onclick="app.paginationManager.firstPage()" id="firstPageBtn">
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button onclick="app.paginationManager.previousPage()" id="prevPageBtn">
                    <i class="fas fa-angle-left"></i>
                </button>
                <div id="pageNumbers"></div>
                <button onclick="app.paginationManager.nextPage()" id="nextPageBtn">
                    <i class="fas fa-angle-right"></i>
                </button>
                <button onclick="app.paginationManager.lastPage()" id="lastPageBtn">
                    <i class="fas fa-angle-double-right"></i>
                </button>
                <span class="pagination-info" id="paginationInfo"></span>
            </div>
        </div>

        <!-- VIEW: SCHEDULE -->
        <div id="view-schedule" class="view-section">
            <div class="toolbar">
                <div style="display: flex; gap: 20px; align-items: center; width: 100%;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-calendar-week" style="font-size:24px; color:var(--primary);"></i>
                        <h2 style="font-size:18px; font-weight:700;" data-i18n="title_weekly_schedule">Weekly Master Schedule</h2>
                    </div>
                    <div style="flex:1;"></div>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="app.printContent()">
                            <i class="fas fa-print"></i> <span data-i18n="btn_print">Print Schedule</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="scheduleTable">
                    <thead>
                        <tr id="scheduleHeader">
                            <th data-i18n="col_staff">Staff Member</th>
                            <th data-i18n="day_sun">Sunday</th>
                            <th data-i18n="day_mon">Monday</th>
                            <th data-i18n="day_tue">Tuesday</th>
                            <th data-i18n="day_wed">Wednesday</th>
                            <th data-i18n="day_thu">Thursday</th>
                            <th data-i18n="day_fri">Friday</th>
                            <th data-i18n="day_sat">Saturday</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: REQUESTS -->
        <div id="view-requests" class="view-section">
            <div class="toolbar">
                <div style="display: flex; gap: 20px; align-items: center; width: 100%;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-plane-departure" style="font-size:24px; color:var(--primary);"></i>
                        <h2 style="font-size:18px; font-weight:700;" data-i18n="title_leave_requests">Leave Requests</h2>
                    </div>
                    <div style="flex:1;"></div>
                    <div class="search-wrapper" style="width: 200px;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="reqSearchInput" class="search-input" placeholder="Search..." data-i18n-ph="search">
                    </div>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="app.openRequestModal()">
                            <i class="fas fa-plus-circle"></i> <span data-i18n="btn_new_req">New Request</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="req-table">
                    <thead>
                        <tr>
                            <th data-i18n="col_emp">Employee</th>
                            <th data-i18n="col_type">Type</th>
                            <th data-i18n="col_reason">Reason / Notes</th>
                            <th data-i18n="col_dates">Dates (Start - End)</th>
                            <th data-i18n="col_duration">Duration</th>
                            <th data-i18n="col_status">Status</th>
                            <th class="no-print" data-i18n="col_actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requestsBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: SUMMARY REPORT -->
        <div id="view-summary" class="view-section">
            <div class="toolbar">
                <div style="display: flex; gap: 20px; align-items: center; width: 100%;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-chart-line" style="font-size:24px; color:var(--primary);"></i>
                        <h2 style="font-size:18px; font-weight:700;" data-i18n="title_monthly_summary">Monthly Summary</h2>
                    </div>
                    <div style="flex:1;"></div>
                    <div class="actions">
                        <button class="btn btn-info" onclick="app.exportToExcel()">
                            <i class="fas fa-file-excel"></i> <span data-i18n="btn_export_excel">Export Excel</span>
                        </button>
                        <button class="btn btn-secondary" onclick="app.exportToCSV()">
                            <i class="fas fa-file-csv"></i> <span data-i18n="btn_export_csv">Export CSV</span>
                        </button>
                        <button class="btn btn-secondary" onclick="app.printContent()">
                            <i class="fas fa-print"></i> <span data-i18n="btn_print">Print / PDF</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="charts-container" id="chartsContainer">
                <div class="chart-card">
                    <div class="chart-title" data-i18n="chart_title_att">Attendance Overview</div>
                    <canvas id="attendanceChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title" data-i18n="chart_title_ot">Overtime Hours</div>
                    <canvas id="overtimeChart" width="400" height="200"></canvas>
                </div>
            </div>

            <div class="table-wrapper">
                <div class="arabic-header" data-i18n="header_period">تاريخ الفترة (Date Period)</div>
                <table class="summary-table" style="background:white; border:1px solid #000;">
                    <thead>
                        <tr>
                            <th data-i18n="col_no">No</th>
                            <th data-i18n="col_name">Employee name</th>
                            <th data-i18n="col_work">Working days</th>
                            <th data-i18n="col_absent">Absent Days</th>
                            <th data-i18n="col_vac">Vacation Days</th>
                            <th data-i18n="col_sick">Sick Days</th>
                            <th data-i18n="col_tot_days">Total days</th>
                            <th data-i18n="col_ot_hours">Overtime Hours</th>
                            <th data-i18n="col_ot_days">Overtime Days</th>
                            <th data-i18n="col_tot_ot">Total over time</th>
                        </tr>
                    </thead>
                    <tbody id="summaryBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Hidden Print Container -->
    <div id="printContainer" class="no-print"></div>

    <!-- Hidden Print Area -->
    <div id="printEmployeeArea" class="no-print"></div>

    <!-- Modals -->
    
    <!-- 1. Shift Edit Modal -->
    <div class="modal no-print" id="shiftModal">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title" style="color:var(--primary);">
                    <i class="fas fa-clock"></i> <span data-i18n="modal_edit_shift">Edit Shift</span>
                </div>
                <button class="close-modal" onclick="app.closeModals()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" data-i18n="lbl_emp">Employee</label>
                    <input type="text" id="shiftEmpName" class="form-input" disabled style="background:var(--bg-body);">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="lbl_day">Day</label>
                    <input type="text" id="shiftDayName" class="form-input" disabled style="background:var(--bg-body);">
                </div>
                <div class="form-group">
                    <label class="form-label" style="display:flex; justify-content:space-between;">
                        <span data-i18n="lbl_primary_shift">Primary Shift</span>
                        <label style="font-weight:400; cursor:pointer;">
                            <input type="checkbox" id="shiftOffDay" onchange="app.toggleShiftInputs()"> <span data-i18n="lbl_off_day">Off Day</span>
                        </label>
                    </label>
                    <div id="primaryShiftGroup" class="time-group">
                        <div>
                            <label class="form-label" data-i18n="lbl_start">Start</label>
                            <input type="time" id="shiftStart1" class="form-input">
                        </div>
                        <div>
                            <label class="form-label" data-i18n="lbl_end">End</label>
                            <input type="time" id="shiftEnd1" class="form-input">
                        </div>
                    </div>
                </div>
                <div class="form-group" id="secondaryShiftGroup">
                    <label class="form-label" data-i18n="lbl_sec_shift">Secondary Shift (Optional / Split)</label>
                    <div class="time-group">
                        <div>
                            <label class="form-label" data-i18n="lbl_start">Start</label>
                            <input type="time" id="shiftStart2" class="form-input">
                        </div>
                        <div>
                            <label class="form-label" data-i18n="lbl_end">End</label>
                            <input type="time" id="shiftEnd2" class="form-input">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="app.saveShift(true)" data-i18n="btn_clear_shift">Clear Shift</button>
                <button class="btn btn-primary" onclick="app.saveShift(false)" data-i18n="btn_save_shift">Save Schedule</button>
            </div>
        </div>
    </div>

    <!-- 2. Employee Modal -->
    <div class="modal no-print" id="employeeModal">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-id-card"></i> <span data-i18n="modal_emp_file">Employee File</span>
                </div>
                <button class="close-modal" onclick="app.closeModals()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img id="empPhotoPreview" src="https://via.placeholder.com/80" style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:3px solid var(--border);">
                    <div>
                        <label for="empPhotoInput" style="font-size:12px; color:var(--primary); font-weight:600; cursor:pointer; display:block; margin-top:10px;">
                            <i class="fas fa-camera"></i> <span data-i18n="lbl_change_photo">Change Photo</span>
                        </label>
                        <input type="file" id="empPhotoInput" accept="image/*" style="display: none;">
                    </div>
                </div>
                <input type="hidden" id="empPhotoBase64">
                <div class="form-grid">
                    <div style="grid-column: span 2; text-align: center; margin-bottom: 20px;">
                        <label style="font-size:12px; font-weight:700; color:var(--primary); text-transform:uppercase;" data-i18n="hdr_personal_info">Personal Information</label>
                    </div>
                    <div class="form-group"><label class="form-label required" data-i18n="lbl_name">Full Name</label><input type="text" id="empName" class="form-input"></div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_job_no">Job Number</label><input type="text" id="empJobNumber" class="form-input"></div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_phone">Phone</label><input type="tel" id="empPhone" class="form-input"></div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_nat">Nationality</label><input type="text" id="empNationality" class="form-input"></div>
                    <div style="grid-column: span 2; margin-bottom:10px; border-bottom:1px solid var(--border); padding-bottom:10px;">
                        <label style="font-size:12px; font-weight:700; color:var(--primary); text-transform:uppercase;" data-i18n="hdr_compliance">Compliance Documents</label>
                    </div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_pass_no">Passport No.</label><input type="text" id="empPassportNo" class="form-input"></div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_pass_exp">Passport Exp</label><input type="date" id="empPassportExp" class="form-input"></div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_eid_no">EID No.</label><input type="text" id="empEIDNo" class="form-input"></div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_eid_exp">EID Exp</label><input type="date" id="empEIDExp" class="form-input"></div>
                    <div style="grid-column: span 2; margin-bottom:10px; margin-top:10px; border-bottom:1px solid var(--border); padding-bottom:10px;">
                        <label style="font-size:12px; font-weight:700; color:var(--primary); text-transform:uppercase;" data-i18n="hdr_hr_settings">HR Settings</label>
                    </div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_join_date">Join Date</label><input type="date" id="empJoinDate" class="form-input"></div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_weekly_off">Weekly Off</label>
                        <select id="empWeeklyOff" class="form-select">
                            <option value="-1">None</option>
                            <option value="0">Sun</option><option value="1">Mon</option><option value="2">Tue</option>
                            <option value="3">Wed</option><option value="4">Thu</option><option value="5">Fri</option><option value="6">Sat</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_labor_card">Labor Card</label><input type="text" id="empLaborCard" class="form-input"></div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_ins_exp">Insurance Exp</label><input type="date" id="empInsuranceExp" class="form-input"></div>
                </div>
            </div>
            <input type="hidden" id="editEmpId">
            <div class="modal-footer">
                <button class="btn btn-danger" id="deleteEmpBtn" style="display: none;" onclick="app.deleteEmployee()" data-i18n="btn_delete_emp">Delete</button>
                <button class="btn btn-secondary" id="printEmpBtn" onclick="app.printEmployeeProfile()">
                    <i class="fas fa-print"></i> <span data-i18n="btn_print">Print Profile</span>
                </button>
                <button class="btn btn-primary" onclick="app.saveEmployee()" data-i18n="btn_save_file">Save File</button>
            </div>
        </div>
    </div>

    <!-- 3. Attendance Edit Modal -->
    <div class="modal no-print" id="attendanceModal">
        <div class="modal-card" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-title" data-i18n="modal_edit_att">Edit Attendance</div>
                <button class="close-modal" onclick="app.closeModals()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label" data-i18n="lbl_emp">Employee</label><input type="text" id="modalEmpName" class="form-input" disabled></div>
                <div class="form-group"><label class="form-label" data-i18n="lbl_date">Date</label><input type="text" id="modalDate" class="form-input" disabled></div>
                <div class="form-group"><label class="form-label" data-i18n="lbl_status">Status</label>
                    <select id="modalStatus" class="form-select" onchange="app.toggleHoursInput()">
                        <option value="present">Present</option><option value="absent">Absent</option><option value="vacation">Vacation</option><option value="unpaid">Unpaid Leave</option><option value="sick">Sick</option><option value="weeklyoff">Weekly Off</option><option value="emergency">Emergency</option>
                    </select>
                </div>
                <div class="form-group" id="hoursGroup">
                    <label class="form-label" data-i18n="lbl_tot_hours">Total Hours</label>
                    <input type="number" id="modalHours" class="form-input" value="9" min="0" max="24" step="0.5">
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="app.saveAttendance()" data-i18n="btn_update">Update</button></div>
        </div>
    </div>

    <!-- 4. OT Modal -->
    <div class="modal no-print" id="otModal">
        <div class="modal-card" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-title" style="color: var(--warning);">
                    <i class="fas fa-clock"></i> <span data-i18n="modal_overtime">Overtime</span>
                </div>
                <button class="close-modal" onclick="app.closeModals()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label" data-i18n="lbl_emp">Employee</label><select id="otEmpSelect" class="form-select"></select></div>
                <div class="form-group"><label class="form-label" data-i18n="lbl_range">Range</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <input type="date" id="otStart" class="form-input"><input type="date" id="otEnd" class="form-input">
                    </div>
                </div>
                <div class="form-group"><label class="form-label" data-i18n="lbl_hours">Hours</label><input type="number" id="otHours" class="form-input" value="2" step="0.5"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-warning" onclick="app.applyQuickOT()" data-i18n="btn_apply">Apply</button></div>
        </div>
    </div>

    <!-- 5. Bulk Modal -->
    <div class="modal no-print" id="bulkModal">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title" data-i18n="modal_bulk_update">Bulk Update</div>
                <button class="close-modal" onclick="app.closeModals()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div class="form-group"><label class="form-label" data-i18n="lbl_emp">Employee</label><select id="bulkEmpSelect" class="form-select"></select></div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_status">Status</label><select id="bulkStatus" class="form-select">
                        <option value="present">Present</option><option value="absent">Absent</option><option value="vacation">Vacation</option><option value="unpaid">Unpaid</option><option value="sick">Sick</option><option value="weeklyoff">Off</option>
                    </select></div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_start">Start</label><input type="date" id="bulkStart" class="form-input"></div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_end">End</label><input type="date" id="bulkEnd" class="form-input"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="app.applyBulkAction()" data-i18n="btn_apply">Apply</button></div>
        </div>
    </div>

    <!-- 6. Request Modal -->
    <div class="modal no-print" id="requestModal">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-plane-departure"></i> <span data-i18n="modal_leave_req">Leave Request</span>
                </div>
                <button class="close-modal" onclick="app.closeModals()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label" data-i18n="lbl_emp">Employee</label><select id="reqEmpSelect" class="form-select"></select></div>
                <div class="form-grid">
                    <div class="form-group"><label class="form-label" data-i18n="lbl_req_type">Request Type</label><select id="reqType" class="form-select">
                            <option value="vacation">Annual Vacation (Paid)</option><option value="unpaid">Unpaid Leave</option>
                        </select></div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_start_date">Start Date (Month/Date)</label><input type="date" id="reqStart" class="form-input" onchange="app.calculateReturnDate()"></div>
                </div>
                <div class="form-grid">
                    <div class="form-group"><label class="form-label" data-i18n="lbl_how_long">How Long? (Days)</label><input type="number" id="reqDuration" class="form-input" value="1" min="1" max="30" oninput="app.calculateReturnDate()"></div>
                    <div class="form-group"><label class="form-label" data-i18n="lbl_return_date">When Come Back?</label><input type="text" id="reqReturnDisplay" class="form-input" readonly style="background: var(--bg-body); font-weight: 600; color: var(--primary);">
                        <input type="hidden" id="reqEndCalc">
                    </div>
                </div>
                <div class="form-group"><label class="form-label" data-i18n="lbl_reason">Reason / Notes</label><textarea id="reqReason" class="form-textarea" placeholder="Reason for leave..." data-i18n-ph="reason_ph"></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModals()" data-i18n="btn_cancel">Cancel</button>
                <button class="btn btn-primary" onclick="app.submitRequest()" data-i18n="btn_submit">Submit Request</button>
            </div>
        </div>
    </div>

    <!-- 7. System Info Modal -->
    <div class="modal no-print" id="infoModal">
        <div class="modal-card" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-info-circle"></i> <span data-i18n="title_system_info">System Info & Roadmap</span></div>
                <button class="close-modal" onclick="app.closeModals()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="roadmap-list">
                    <div class="roadmap-item">
                        <div class="roadmap-status done"></div>
                        <div class="roadmap-content">
                            <h4>v6.1 (Current)</h4>
                            <p>Enhanced Security, Performance Optimization, Auto-Backup, Improved UX.</p>
                        </div>
                    </div>
                    <div class="roadmap-item">
                        <div class="roadmap-status pending"></div>
                        <div class="roadmap-content">
                            <h4>v6.2 (Q2 2025)</h4>
                            <p>Cloud Sync, Mobile App (PWA), Advanced Analytics.</p>
                        </div>
                    </div>
                    <div class="roadmap-item">
                        <div class="roadmap-status future"></div>
                        <div class="roadmap-content">
                            <h4>v7.0 (Future)</h4>
                            <p>AI-Powered Insights, Payroll Integration.</p>
                        </div>
                    </div>
                </div>
                <div style="border-top: 1px solid var(--border); padding-top: 20px; margin-top: 10px;">
                    <p style="font-size: 13px; color: var(--text-muted);"><strong>Support Email:</strong> support@hrmaster.app</p>
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 5px;">Built for Enterprise Scalability.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 8. System Logs Modal -->
    <div class="modal no-print" id="logsModal">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-history"></i> <span data-i18n="title_system_logs">System Logs</span></div>
                <button class="close-modal" onclick="app.closeModals()">&times;</button>
            </div>
            <div class="modal-body">
                <table class="log-table">
                    <thead><tr><th>Time</th><th>Type</th><th>Message</th><th>Action</th></tr></thead>
                    <tbody id="logsTableBody"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="app.clearLogs()" data-i18n="btn_clear_logs">Clear Logs</button>
                <button class="btn btn-secondary" onclick="app.closeModals()">Close</button>
            </div>
        </div>
    </div>

    <!-- 9. Backup Manager Modal -->
    <div class="modal no-print" id="backupModal">
        <div class="modal-card" style="max-width: 800px;">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-database"></i> <span data-i18n="title_backup_manager">Backup Manager</span></div>
                <button class="close-modal" onclick="app.closeModals()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="app.backupManager.createBackup()">
                        <i class="fas fa-plus"></i> Create New Backup
                    </button>
                    <button class="btn btn-secondary" onclick="app.backupManager.autoBackupToggle()" id="autoBackupBtn">
                        <i class="fas fa-clock"></i> <span id="autoBackupText">Enable Auto Backup</span>
                    </button>
                </div>
                <div id="backupList">
                    <!-- Backup list will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeModals()">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMsg">Saved</span>
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        /**
         * Logger Class - Enhanced with structured logging
         */
        class Logger {
            static log(type = 'info', message, context = '') {
                try {
                    const timestamp = new Date().toISOString();
                    const entry = { timestamp, type, message, context };
                    
                    // Get existing logs (keep last 200 for better tracking)
                    let logs = JSON.parse(localStorage.getItem('hr_system_logs') || '[]');
                    logs.unshift(entry);
                    if(logs.length > 200) logs.pop();
                    
                    localStorage.setItem('hr_system_logs', JSON.stringify(logs));
                    
                    console.log(`[HR Master v6.1] [${type.toUpperCase()}] ${context ? `[${context}] ` : ''}${message}`);
                } catch (e) {
                    console.error("Logger failed", e);
                }
            }
        }

        /**
         * Security Manager - Enhanced PIN system
         */
        class SecurityManager {
            constructor() {
                this.attempts = 0;
                this.maxAttempts = 3;
                this.lockoutDuration = 5 * 60 * 1000; // 5 minutes
                this.pinHash = localStorage.getItem('hr_system_pin_hash') || this.hashPin('0000');
            }
            
            async verifyPin(pin) {
                const hashedPin = this.hashPin(pin);
                
                if (hashedPin !== this.pinHash) {
                    this.attempts++;
                    if (this.attempts >= this.maxAttempts) {
                        this.lockSystem();
                        return false;
                    }
                    return false;
                }
                
                this.attempts = 0;
                return true;
            }
            
            hashPin(pin) {
                // Simple hash for demo (use crypto in production)
                let hash = 0;
                for (let i = 0; i < pin.length; i++) {
                    const char = pin.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString();
            }
            
            setPin(pin) {
                this.pinHash = this.hashPin(pin);
                localStorage.setItem('hr_system_pin_hash', this.pinHash);
            }
            
            lockSystem() {
                const lockUntil = Date.now() + this.lockoutDuration;
                localStorage.setItem('hr_system_locked_until', lockUntil.toString());
                app.showLockScreen();
            }
            
            isLocked() {
                const lockUntil = parseInt(localStorage.getItem('hr_system_locked_until') || '0');
                return Date.now() < lockUntil;
            }
        }

        /**
         * Cache Manager - Performance optimization
         */
        class CacheManager {
            constructor(maxSize = 100) {
                this.cache = new Map();
                this.maxSize = maxSize;
            }
            
            get(key) {
                if (this.cache.has(key)) {
                    const value = this.cache.get(key);
                    this.cache.delete(key);
                    this.cache.set(key, value);
                    return value;
                }
                return null;
            }
            
            set(key, value) {
                if (this.cache.size >= this.maxSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                this.cache.set(key, value);
            }
            
            clear() {
                this.cache.clear();
            }
        }

        /**
         * Pagination Manager - For large datasets
         */
        class PaginationManager {
            constructor(itemsPerPage = 20) {
                this.itemsPerPage = itemsPerPage;
                this.currentPage = 1;
                this.totalItems = 0;
                this.totalPages = 0;
                this.data = [];
            }
            
            setData(data) {
                this.data = data;
                this.totalItems = data.length;
                this.totalPages = Math.ceil(this.totalItems / this.itemsPerPage);
                this.currentPage = 1;
            }
            
            getPage() {
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                return this.data.slice(startIndex, endIndex);
            }
            
            firstPage() {
                this.currentPage = 1;
                return this.getPage();
            }
            
            lastPage() {
                this.currentPage = this.totalPages;
                return this.getPage();
            }
            
            nextPage() {
                if (this.currentPage < this.totalPages) {
                    this.currentPage++;
                }
                return this.getPage();
            }
            
            previousPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                }
                return this.getPage();
            }
            
            goToPage(page) {
                if (page >= 1 && page <= this.totalPages) {
                    this.currentPage = page;
                }
                return this.getPage();
            }
        }

        /**
         * Loading Manager - Better UX
         */
        class LoadingManager {
            constructor() {
                this.overlay = document.getElementById('loadingOverlay');
                this.message = document.getElementById('loadingMessage');
            }
            
            show(message = 'Loading...') {
                this.message.textContent = message;
                this.overlay.classList.add('active');
            }
            
            hide() {
                this.overlay.classList.remove('active');
            }
        }

        /**
         * Error Handler - Friendly error messages
         */
        class ErrorHandler {
            static show(error, context = '') {
                console.error(`Error in ${context}:`, error);
                
                const errorToast = document.createElement('div');
                errorToast.className = 'toast error show';
                errorToast.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i>
                    <span>${this.getFriendlyMessage(error)}</span>
                `;
                
                document.body.appendChild(errorToast);
                
                setTimeout(() => {
                    errorToast.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(errorToast)) {
                            document.body.removeChild(errorToast);
                        }
                    }, 300);
                }, 5000);
            }
            
            static getFriendlyMessage(error) {
                if (error.name === 'NetworkError' || error.message.includes('fetch')) {
                    return 'Network connection error. Please check your internet connection.';
                } else if (error.name === 'ValidationError') {
                    return 'Please check your input and try again.';
                } else if (error.message.includes('Storage')) {
                    return 'Storage error. Please clear browser data and try again.';
                } else {
                    return 'An unexpected error occurred. Please try again later.';
                }
            }
        }

        /**
         * Backup Manager - Auto backup functionality
         */
        class BackupManager {
            constructor() {
                this.backupInterval = null;
                this.isAutoBackupEnabled = localStorage.getItem('hr_auto_backup') === 'true';
                this.maxBackups = 10;
            }
            
            createBackup() {
                const data = {
                    employees: app.data.employees,
                    attendance: app.data.attendance,
                    schedule: app.data.schedule,
                    requests: app.data.requests,
                    timestamp: new Date().toISOString(),
                    version: '6.1'
                };
                
                const backups = JSON.parse(localStorage.getItem('hr_system_backups') || '[]');
                backups.unshift(data);
                
                if (backups.length > this.maxBackups) {
                    backups.pop();
                }
                
                localStorage.setItem('hr_system_backups', JSON.stringify(backups));
                Logger.log('info', 'Manual backup created', 'BackupManager');
                app.showToast('Backup created successfully', 'success');
                this.renderBackupList();
            }
            
            restoreBackup(backupIndex) {
                const backups = JSON.parse(localStorage.getItem('hr_system_backups') || '[]');
                if (backupIndex >= 0 && backupIndex < backups.length) {
                    const backup = backups[backupIndex];
                    if (confirm(`Restore backup from ${new Date(backup.timestamp).toLocaleString()}?`)) {
                        app.data.employees = backup.employees;
                        app.data.attendance = backup.attendance;
                        app.data.schedule = backup.schedule;
                        app.data.requests = backup.requests;
                        app.saveData();
                        app.renderTable();
                        app.renderSchedule();
                        app.renderRequests();
                        app.renderSummary();
                        Logger.log('info', 'Backup restored', 'BackupManager');
                        app.showToast('Backup restored successfully', 'success');
                    }
                }
            }
            
            deleteBackup(backupIndex) {
                const backups = JSON.parse(localStorage.getItem('hr_system_backups') || '[]');
                if (backupIndex >= 0 && backupIndex < backups.length) {
                    backups.splice(backupIndex, 1);
                    localStorage.setItem('hr_system_backups', JSON.stringify(backups));
                    Logger.log('info', 'Backup deleted', 'BackupManager');
                    app.showToast('Backup deleted', 'info');
                    this.renderBackupList();
                }
            }
            
            autoBackupToggle() {
                this.isAutoBackupEnabled = !this.isAutoBackupEnabled;
                localStorage.setItem('hr_auto_backup', this.isAutoBackupEnabled.toString());
                
                if (this.isAutoBackupEnabled) {
                    this.startAutoBackup();
                    document.getElementById('autoBackupText').textContent = 'Disable Auto Backup';
                    app.showToast('Auto backup enabled', 'success');
                } else {
                    this.stopAutoBackup();
                    document.getElementById('autoBackupText').textContent = 'Enable Auto Backup';
                    app.showToast('Auto backup disabled', 'info');
                }
            }
            
            startAutoBackup() {
                this.stopAutoBackup(); // Clear any existing interval
                this.backupInterval = setInterval(() => {
                    this.createBackup();
                }, 24 * 60 * 60 * 1000); // Every 24 hours
            }
            
            stopAutoBackup() {
                if (this.backupInterval) {
                    clearInterval(this.backupInterval);
                    this.backupInterval = null;
                }
            }
            
            renderBackupList() {
                const backups = JSON.parse(localStorage.getItem('hr_system_backups') || '[]');
                const listContainer = document.getElementById('backupList');
                
                if (backups.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; color: var(--text-muted);">No backups available</p>';
                    return;
                }
                
                listContainer.innerHTML = backups.map((backup, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px;">
                        <div>
                            <strong>${new Date(backup.timestamp).toLocaleString()}</strong>
                            <br>
                            <small style="color: var(--text-muted);">Version: ${backup.version || 'Unknown'}</small>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="app.backupManager.restoreBackup(${index})" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-undo"></i> Restore
                            </button>
                            <button class="btn btn-danger" onclick="app.backupManager.deleteBackup(${index})" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        const CONFIG = {
            storageKeys: { 
                employees: 'att_v61_employees', 
                data: 'att_v61_data', 
                schedule: 'att_v61_schedule', 
                leaves: 'att_v61_requests',
                theme: 'att_v61_theme',
                lang: 'att_v61_lang',
                logs: 'hr_system_logs',
                backups: 'hr_system_backups'
            },
            statusColors: { 
                present: '#dcfce7', 
                overtime: '#cffafe', 
                absent: '#fee2e2', 
                vacation: '#fef3c7', 
                unpaid: '#f1f5f9', 
                sick: '#ede9fe', 
                weeklyoff: '#dbeafe' 
            },
            translations: {
                en: {
                    tab_attendance: "Attendance Log",
                    tab_schedule: "Schedule",
                    tab_requests: "Leave Requests",
                    tab_summary: "Summary Report",
                    col_emp_details: "Employee Details",
                    col_emp: "Employee",
                    col_type: "Type",
                    col_reason: "Reason / Notes",
                    col_dates: "Dates (Start - End)",
                    col_duration: "Duration",
                    col_status: "Status",
                    col_actions: "Actions",
                    col_staff: "Staff Member",
                    col_name: "Employee name",
                    col_work: "Working days",
                    col_absent: "Absent Days",
                    col_vac: "Vacation Days",
                    col_sick: "Sick Days",
                    col_tot_days: "Total days",
                    col_ot_hours: "Overtime Hours",
                    col_ot_days: "Overtime Days",
                    col_tot_ot: "Total over time",
                    col_no: "No",
                    title_weekly_schedule: "Weekly Master Schedule",
                    title_leave_requests: "Leave Requests",
                    title_monthly_summary: "Monthly Summary",
                    btn_edit_ot: "Edit OT",
                    btn_bulk: "Bulk",
                    btn_add_emp: "Add Emp",
                    btn_print: "Print Schedule",
                    btn_export_excel: "Export Excel",
                    btn_export_csv: "Export CSV",
                    btn_print: "Print / PDF",
                    btn_new_req: "New Request",
                    modal_edit_shift: "Edit Shift",
                    lbl_emp: "Employee",
                    lbl_day: "Day",
                    lbl_primary_shift: "Primary Shift",
                    lbl_off_day: "Off Day",
                    lbl_sec_shift: "Secondary Shift",
                    btn_clear_shift: "Clear Shift",
                    btn_save_shift: "Save Schedule",
                    modal_emp_file: "Employee File",
                    lbl_change_photo: "Change Photo",
                    hdr_personal_info: "Personal Information",
                    lbl_name: "Full Name",
                    lbl_job_no: "Job Number",
                    lbl_phone: "Phone",
                    lbl_nat: "Nationality",
                    hdr_compliance: "Compliance Documents",
                    lbl_pass_no: "Passport No.",
                    lbl_pass_exp: "Passport Exp",
                    lbl_eid_no: "EID No.",
                    lbl_eid_exp: "EID Exp",
                    hdr_hr_settings: "HR Settings",
                    lbl_join_date: "Join Date",
                    lbl_weekly_off: "Weekly Off",
                    lbl_labor_card: "Labor Card",
                    lbl_ins_exp: "Insurance Exp",
                    btn_delete_emp: "Delete",
                    btn_print: "Print Profile",
                    btn_save_file: "Save File",
                    modal_edit_att: "Edit Attendance",
                    lbl_date: "Date",
                    lbl_status: "Status",
                    lbl_tot_hours: "Total Hours",
                    btn_update: "Update",
                    modal_overtime: "Overtime",
                    lbl_range: "Range",
                    lbl_hours: "Hours",
                    btn_apply: "Apply",
                    modal_bulk_update: "Bulk Update",
                    lbl_start: "Start",
                    lbl_end: "End",
                    modal_leave_req: "Leave Request",
                    lbl_req_type: "Request Type",
                    lbl_start_date: "Start Date",
                    lbl_how_long: "How Long? (Days)",
                    lbl_return_date: "When Come Back?",
                    lbl_reason: "Reason / Notes",
                    btn_cancel: "Cancel",
                    btn_submit: "Submit Request",
                    menu_system_info: "System Info & Roadmap",
                    menu_system_logs: "System Logs",
                    menu_backup_manager: "Backup Manager",
                    menu_backup: "Download Backup",
                    menu_import: "Import CSV Staff",
                    menu_restore: "Restore Backup (JSON)",
                    menu_reset: "Reset All Data",
                    lbl_month: "Month:",
                    header_period: "Date Period",
                    chart_title_att: "Attendance Overview",
                    chart_title_ot: "Overtime Hours",
                    title_backup_manager: "Backup Manager",
                    btn_clear_logs: "Clear Logs",
                    search_emp: "Search employee...",
                    search: "Search...",
                    reason_ph: "Reason for leave...",
                    status_pending: "Pending",
                    status_approved: "Approved",
                    status_rejected: "Rejected",
                    toast_success: "Operation successful",
                    toast_saved: "Saved",
                    toast_sub: "Submitted",
                    toast_approved: "Approved",
                    toast_rejected: "Rejected",
                    vacation: "Vacation",
                    unpaid: "Unpaid",
                    btn_approve: "Approve",
                    btn_reject: "Reject",
                    lbl_days: "Days",
                    lbl_off: "Off",
                    day_sun: "Sunday",
                    day_mon: "Monday",
                    day_tue: "Tuesday",
                    day_wed: "Wednesday",
                    day_thu: "Thursday",
                    day_fri: "Friday",
                    day_sat: "Saturday"
                },
                ar: {
                    tab_attendance: "سجل الحضور",
                    tab_schedule: "جدول العمل",
                    tab_requests: "طلبات الإجازة",
                    tab_summary: "ملخص التقرير الشهري",
                    col_emp_details: "بيانات الموظف",
                    col_emp: "الموظف",
                    col_type: "النوع",
                    col_reason: "السبب / الملاحظات",
                    col_dates: "التواريخ (البداية - النهاية)",
                    col_duration: "المدة",
                    col_status: "الحالة",
                    col_actions: "الإجراءات",
                    col_staff: "عضو الموظفين",
                    col_name: "اسم الموظف",
                    col_work: "أيام العمل",
                    col_absent: "أيام الغياب",
                    col_vac: "أيام الإجازة",
                    col_sick: "أيام المرض",
                    col_tot_days: "إجمالي الأيام",
                    col_ot_hours: "ساعات العمل الإضافية",
                    col_ot_days: "أيام العمل الإضافية",
                    col_tot_ot: "إجمالي العمل الإضافي",
                    col_no: "رقم",
                    title_weekly_schedule: "جدول العمل الأسبوعي",
                    title_leave_requests: "طلبات الإجازة",
                    title_monthly_summary: "ملخص التقرير الشهري",
                    btn_edit_ot: "تعديل العمل الإضافي",
                    btn_bulk: "تعديل جماعي",
                    btn_add_emp: "إضافة موظف",
                    btn_print: "طباعة الجدول",
                    btn_export_excel: "تصدير Excel",
                    btn_export_csv: "تصدير CSV",
                    btn_print: "طباعة / PDF",
                    btn_new_req: "طلب جديد",
                    modal_edit_shift: "تعديل ورديات العمل",
                    lbl_emp: "الموظف",
                    lbl_day: "اليوم",
                    lbl_primary_shift: "الوردية الأساسية",
                    lbl_off_day: "إجازة",
                    lbl_sec_shift: "الوردية الثانوية (اختياري)",
                    btn_clear_shift: "مسح الوردية",
                    btn_save_shift: "حفظ الجدول",
                    modal_emp_file: "ملف الموظف",
                    lbl_change_photo: "تغيير الصورة",
                    hdr_personal_info: "معلومات شخصية",
                    lbl_name: "الاسم الكامل",
                    lbl_job_no: "رقم الوظيفة",
                    lbl_phone: "رقم الهاتف",
                    lbl_nat: "الجنسية",
                    hdr_compliance: "المستندات الامتثال",
                    lbl_pass_no: "رقم جواز السفر",
                    lbl_pass_exp: "تاريخ انتهاء جواز السفر",
                    lbl_eid_no: "رقم الهوية",
                    lbl_eid_exp: "تاريخ انتهاء الهوية",
                    hdr_hr_settings: "إعدادات الموارد البشرية",
                    lbl_join_date: "تاريخ الانضمام",
                    lbl_weekly_off: "إجازة أسبوعية",
                    lbl_labor_card: "بطاقة العمل",
                    lbl_ins_exp: "تاريخ انتهاء التأمين",
                    btn_delete_emp: "حذف",
                    btn_print: "طباعة الملف",
                    btn_save_file: "حفظ الملف",
                    modal_edit_att: "تعديل الحضور",
                    lbl_date: "التاريخ",
                    lbl_status: "الحالة",
                    lbl_tot_hours: "إجمالي الساعات",
                    btn_update: "تحديث",
                    modal_overtime: "العمل الإضافي",
                    lbl_range: "الفترة",
                    lbl_hours: "ساعات",
                    btn_apply: "تطبيق",
                    modal_bulk_update: "تعديل جماعي",
                    lbl_start: "البداية",
                    lbl_end: "النهاية",
                    modal_leave_req: "طلب إجازة",
                    lbl_req_type: "نوع الطلب",
                    lbl_start_date: "تاريخ البداية",
                    lbl_how_long: "كم المدة؟ (أيام)",
                    lbl_return_date: "متى يعود؟",
                    lbl_reason: "السبب / ملاحظات",
                    btn_cancel: "إلغاء",
                    btn_submit: "تقديم الطلب",
                    menu_system_info: "معلومات النظام وخارطة الطريق",
                    menu_system_logs: "سجلات النظام",
                    menu_backup_manager: "مدير النسخ الاحتياطي",
                    menu_backup: "تنزيل النسخة الاحتياطية",
                    menu_import: "استيراد موظفين CSV",
                    menu_restore: "استعادة النسخة الاحتياطية (JSON)",
                    menu_reset: "إعادة ضبط جميع البيانات",
                    lbl_month: "الشهر:",
                    header_period: "تاريخ الفترة",
                    chart_title_att: "نظرة عامة على الحضور",
                    chart_title_ot: "ساعات العمل الإضافية",
                    title_backup_manager: "مدير النسخ الاحتياطي",
                    btn_clear_logs: "مسح السجلات",
                    search_emp: "بحث عن موظف...",
                    search: "بحث...",
                    reason_ph: "سبب الإجازة...",
                    status_pending: "معلق",
                    status_approved: "موافقة",
                    status_rejected: "رفض",
                    toast_success: "عملية ناجحة",
                    toast_saved: "تم الحفظ",
                    toast_sub: "أرسل",
                    toast_approved: "موافقة",
                    toast_rejected: "رفض",
                    vacation: "إجازة",
                    unpaid: "بدون راتب",
                    btn_approve: "موافقة",
                    btn_reject: "رفض",
                    lbl_days: "أيام",
                    lbl_off: "إجازة",
                    day_sun: "الأحد",
                    day_mon: "الإثنين",
                    day_tue: "الثلاثاء",
                    day_wed: "الأربعاء",
                    day_thu: "الخميس",
                    day_fri: "الجمعة",
                    day_sat: "السبت"
                }
            }
        };

        const app = {
            data: { 
                employees: [], 
                attendance: {}, 
                schedule: {}, 
                requests: [], 
                currentMonth: new Date().getMonth(), 
                currentYear: 2025,
                searchTerm: '', 
                reqSearchTerm: '',
                lang: 'en',
                activeTab: 'summary',
                pin: '',
                isLocked: false
            },
            charts: {},
            
            // Module instances
            securityManager: null,
            cacheManager: null,
            paginationManager: null,
            loadingManager: null,
            backupManager: null,
            
            init() {
                try {
                    // Initialize modules
                    this.securityManager = new SecurityManager();
                    this.cacheManager = new CacheManager();
                    this.paginationManager = new PaginationManager();
                    this.loadingManager = new LoadingManager();
                    this.backupManager = new BackupManager();
                    
                    Logger.log('info', 'System initialized with enhanced modules');
                    
                    // Show loading
                    this.loadingManager.show('Initializing system...');
                    
                    // Global error handler
                    window.onerror = (message, source, lineno, colno, error) => {
                        Logger.log('error', `${message} at ${source}:${lineno}`, 'GlobalErrorHandler');
                        ErrorHandler.show(error || new Error(message), 'Global Error');
                    };
                    
                    // Check if system is locked
                    if (this.securityManager.isLocked()) {
                        this.showLockScreen();
                        this.loadingManager.hide();
                        return;
                    }
                    
                    // Load data
                    this.loadData();
                    this.loadTheme();
                    this.loadLang();
                    
                    // Initial render
                    this.renderDateSelectors();
                    this.checkAlerts();
                    this.renderPinPad();
                    this.switchTab(this.data.activeTab);
                    
                    // Event listeners with debouncing
                    this.setupEventListeners();
                    
                    // Start clock
                    this.startClock();
                    
                    // Start auto backup if enabled
                    if (this.backupManager.isAutoBackupEnabled) {
                        this.backupManager.startAutoBackup();
                        document.getElementById('autoBackupText').textContent = 'Disable Auto Backup';
                    }
                    
                    this.loadingManager.hide();
                    Logger.log('info', 'System initialization complete');
                } catch (error) {
                    Logger.log('error', 'Initialization failed', 'App.init');
                    ErrorHandler.show(error, 'System Initialization');
                    this.loadingManager.hide();
                }
            },
            
            setupEventListeners() {
                // Search with debounce
                const searchInput = document.getElementById('searchInput');
                let searchTimeout;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        this.handleSearch();
                    }, 300);
                });
                
                // Request search with debounce
                const reqSearchInput = document.getElementById('reqSearchInput');
                let reqSearchTimeout;
                reqSearchInput.addEventListener('input', (e) => {
                    clearTimeout(reqSearchTimeout);
                    reqSearchTimeout = setTimeout(() => {
                        this.handleReqSearch();
                    }, 300);
                });
                
                // Month/Year change
                document.getElementById('monthSelect').addEventListener('change', (e) => { 
                    this.data.currentMonth = parseInt(e.target.value); 
                    this.renderTable(); 
                    this.renderSummary(); 
                });
                
                document.getElementById('yearSelect').addEventListener('change', (e) => { 
                    this.data.currentYear = parseInt(e.target.value); 
                    this.renderTable(); 
                    this.renderSummary(); 
                });
                
                // Photo upload
                document.getElementById('empPhotoInput').addEventListener('change', (e) => this.handleImageUpload(e));
                
                // Click outside to close dropdown
                document.addEventListener('click', (e) => {
                    if(!e.target.closest('.system-menu')) {
                        document.getElementById('sysDropdown').classList.remove('show');
                    }
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'l') { 
                        e.preventDefault();
                        app.showLockScreen();
                    }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                        e.preventDefault();
                        app.openEmployeeModal();
                    }
                    if ((e.ctrlKey || e.metaKey) && e.key === 's' && document.querySelector('.modal.active')) {
                        e.preventDefault();
                        const activeModal = document.querySelector('.modal.active');
                        if (activeModal.id === 'employeeModal') app.saveEmployee();
                        else if (activeModal.id === 'shiftModal') app.saveShift(false);
                    }
                    if (e.key === 'Escape' && document.querySelector('.modal.active')) app.closeModals();
                });
            },
            
            // --- EMPLOYEE MANAGEMENT FUNCTIONS ---
            openEmployeeModal(empId = null) {
                const modal = document.getElementById('employeeModal');
                const isEdit = empId !== null;
                
                // Reset form
                document.getElementById('empName').value = '';
                document.getElementById('empJobNumber').value = '';
                document.getElementById('empPhone').value = '';
                document.getElementById('empNationality').value = '';
                document.getElementById('empPassportNo').value = '';
                document.getElementById('empPassportExp').value = '';
                document.getElementById('empEIDNo').value = '';
                document.getElementById('empEIDExp').value = '';
                document.getElementById('empJoinDate').value = '';
                document.getElementById('empWeeklyOff').value = '-1';
                document.getElementById('empLaborCard').value = '';
                document.getElementById('empInsuranceExp').value = '';
                document.getElementById('empPhotoBase64').value = '';
                document.getElementById('empPhotoPreview').src = 'https://via.placeholder.com/80';
                document.getElementById('editEmpId').value = '';
                
                // Hide delete button for new employee
                document.getElementById('deleteEmpBtn').style.display = isEdit ? 'block' : 'none';
                
                if (isEdit) {
                    const emp = this.data.employees.find(e => e.id === empId);
                    if (emp) {
                        document.getElementById('empName').value = emp.name || '';
                        document.getElementById('empJobNumber').value = emp.jobNumber || '';
                        document.getElementById('empPhone').value = emp.phone || '';
                        document.getElementById('empNationality').value = emp.nationality || '';
                        document.getElementById('empPassportNo').value = emp.passportNo || '';
                        document.getElementById('empPassportExp').value = emp.passportExp || '';
                        document.getElementById('empEIDNo').value = emp.eidNo || '';
                        document.getElementById('empEIDExp').value = emp.eidExp || '';
                        document.getElementById('empJoinDate').value = emp.joinDate || '';
                        document.getElementById('empWeeklyOff').value = emp.weeklyOff || '-1';
                        document.getElementById('empLaborCard').value = emp.laborCard || '';
                        document.getElementById('empInsuranceExp').value = emp.insuranceExp || '';
                        document.getElementById('empPhotoBase64').value = emp.photo || '';
                        document.getElementById('empPhotoPreview').src = emp.photo || 'https://via.placeholder.com/80';
                        document.getElementById('editEmpId').value = empId;
                    }
                }
                
                modal.classList.add('active');
                Logger.log('info', `Employee modal opened for ${isEdit ? 'edit' : 'add'}`, 'EmployeeManager');
            },
            
            saveEmployee() {
                const name = document.getElementById('empName').value.trim();
                const jobNumber = document.getElementById('empJobNumber').value.trim();
                const phone = document.getElementById('empPhone').value.trim();
                const nationality = document.getElementById('empNationality').value.trim();
                const passportNo = document.getElementById('empPassportNo').value.trim();
                const passportExp = document.getElementById('empPassportExp').value;
                const eidNo = document.getElementById('empEIDNo').value.trim();
                const eidExp = document.getElementById('empEIDExp').value;
                const joinDate = document.getElementById('empJoinDate').value;
                const weeklyOff = document.getElementById('empWeeklyOff').value;
                const laborCard = document.getElementById('empLaborCard').value.trim();
                const insuranceExp = document.getElementById('empInsuranceExp').value;
                const photo = document.getElementById('empPhotoBase64').value;
                const editId = document.getElementById('editEmpId').value;
                
                // Validation
                if (!name) {
                    this.showToast('Name is required', 'error');
                    return;
                }
                
                const empData = {
                    name,
                    jobNumber,
                    phone,
                    nationality,
                    passportNo,
                    passportExp,
                    eidNo,
                    eidExp,
                    joinDate,
                    weeklyOff,
                    laborCard,
                    insuranceExp,
                    photo
                };
                
                if (editId) {
                    // Update existing employee
                    const index = this.data.employees.findIndex(e => e.id === parseInt(editId));
                    if (index !== -1) {
                        this.data.employees[index] = { ...this.data.employees[index], ...empData };
                        Logger.log('info', `Employee updated: ${name}`, 'EmployeeManager');
                    }
                } else {
                    // Add new employee
                    const newEmp = {
                        id: Date.now(),
                        ...empData
                    };
                    this.data.employees.push(newEmp);
                    Logger.log('info', `New employee added: ${name}`, 'EmployeeManager');
                }
                
                this.saveData();
                this.renderTable();
                this.renderSchedule();
                this.closeModals();
                this.showToast('Employee saved successfully', 'success');
            },
            
            deleteEmployee() {
                const editId = document.getElementById('editEmpId').value;
                if (!editId) return;
                
                const emp = this.data.employees.find(e => e.id === parseInt(editId));
                if (!emp) return;
                
                if (confirm(`Are you sure you want to delete ${emp.name}? This action cannot be undone.`)) {
                    // Remove employee
                    this.data.employees = this.data.employees.filter(e => e.id !== parseInt(editId));
                    
                    // Remove related attendance data
                    Object.keys(this.data.attendance).forEach(key => {
                        if (this.data.attendance[key][editId]) {
                            delete this.data.attendance[key][editId];
                        }
                    });
                    
                    // Remove related schedule data
                    if (this.data.schedule[editId]) {
                        delete this.data.schedule[editId];
                    }
                    
                    // Remove related requests
                    this.data.requests = this.data.requests.filter(r => r.empId !== parseInt(editId));
                    
                    this.saveData();
                    this.renderTable();
                    this.renderSchedule();
                    this.renderRequests();
                    this.closeModals();
                    this.showToast('Employee deleted successfully', 'success');
                    Logger.log('info', `Employee deleted: ${emp.name}`, 'EmployeeManager');
                }
            },
            
            // --- System Lock ---
            renderPinPad() {
                const pad = document.getElementById('pinPad');
                pad.innerHTML = '';
                for(let i=1; i<=9; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'pin-btn';
                    btn.innerText = i;
                    btn.onclick = () => app.handlePinInput(i);
                    pad.appendChild(btn);
                }
                // Clear button
                const clearBtn = document.createElement('button');
                clearBtn.className = 'pin-btn';
                clearBtn.innerHTML = 'X';
                clearBtn.onclick = () => {
                    app.data.pin = '';
                    document.getElementById('pinDisplay').textContent = '****';
                };
                clearBtn.style.gridColumn = 'auto';
                pad.appendChild(clearBtn);
            },

            handlePinInput(num) {
                if (this.data.pin.length < 4) {
                    this.data.pin += num;
                    const display = document.getElementById('pinDisplay');
                    display.textContent = '*'.repeat(this.data.pin.length) + '*'.repeat(4 - this.data.pin.length);
                    
                    if(this.data.pin.length === 4) {
                        this.unlockSystem(this.data.pin);
                    }
                }
            },

            async showLockScreen() {
                this.data.isLocked = true;
                document.body.classList.add('locked-screen');
                document.getElementById('pinDisplay').textContent = '****';
                document.getElementById('lockScreenModal').classList.add('active');
                Logger.log('info', 'System locked', 'SecurityManager');
            },

            async unlockSystem(pin) {
                try {
                    const isValid = await this.securityManager.verifyPin(pin);
                    if (isValid) {
                        this.data.isLocked = false;
                        this.data.pin = '';
                        document.body.classList.remove('locked-screen');
                        document.getElementById('lockScreenModal').classList.remove('active');
                        this.showToast('System Unlocked', 'success');
                        Logger.log('info', 'System unlocked successfully', 'SecurityManager');
                    } else {
                        this.showToast('Invalid PIN', 'error');
                        this.shakePinPad();
                        this.data.pin = '';
                        document.getElementById('pinDisplay').textContent = '****';
                    }
                } catch (error) {
                    Logger.log('error', 'PIN verification failed', 'SecurityManager');
                    ErrorHandler.show(error, 'PIN Verification');
                }
            },
            
            shakePinPad() {
                const pad = document.getElementById('pinPad');
                pad.classList.add('shake');
                setTimeout(() => pad.classList.remove('shake'), 500);
            },

            // --- Alerts System ---
            checkAlerts() {
                const alerts = document.getElementById('globalAlerts');
                alerts.innerHTML = '';
                const today = new Date();
                const warningDays = 30;
                let alertCount = 0;
                
                this.data.employees.forEach(emp => {
                    let empAlerts = [];
                    
                    if(emp.passportExp && emp.passportExp !== '') {
                        const expDate = new Date(emp.passportExp);
                        const daysDiff = Math.floor((expDate - today) / (1000 * 60 * 24));
                        if(daysDiff > 0 && daysDiff <= warningDays) {
                            empAlerts.push(`Passport expiring in ${daysDiff} days`);
                        }
                    }
                    
                    if(emp.eidExp && emp.eidExp !== '') {
                        const expDate = new Date(emp.eidExp);
                        const daysDiff = Math.floor((expDate - today) / (1000 * 60 * 24));
                        if(daysDiff > 0 && daysDiff <= warningDays) {
                            empAlerts.push(`EID expiring in ${daysDiff} days`);
                        }
                    }

                    if(empAlerts.length > 0 && alertCount < 3) { // Limit to 3 alerts
                        const alertItem = document.createElement('div');
                        alertItem.className = 'alert-item';
                        alertItem.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${emp.name}: ${empAlerts.join(', ')}`;
                        alerts.appendChild(alertItem);
                        alertCount++;
                    }
                });

                if(alerts.children.length > 0) {
                    alerts.classList.add('active');
                }
            },

            // --- Language System ---
            loadLang() {
                const savedLang = localStorage.getItem(CONFIG.storageKeys.lang);
                if(savedLang) this.data.lang = savedLang;
                document.body.dir = this.data.lang === 'ar' ? 'rtl' : 'ltr';
                document.getElementById('langText').innerText = this.data.lang === 'ar' ? 'عربي' : 'EN';
                if(this.data.lang === 'ar') document.body.classList.add('rtl-mode');
            },
            
            toggleLanguage() {
                this.data.lang = this.data.lang === 'ar' ? 'en' : 'ar';
                localStorage.setItem(CONFIG.storageKeys.lang, this.data.lang);
                this.loadLang();
                this.translateUI();
                Logger.log('info', `Language switched to ${this.data.lang}`, 'LanguageManager');
            },
            
            translateUI() {
                const t = CONFIG.translations[this.data.lang];
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if(t[key]) el.innerText = t[key];
                });
                document.querySelectorAll('[data-i18n-ph]').forEach(el => {
                    const key = el.getAttribute('data-i18n-ph');
                    if(t[key]) el.placeholder = t[key];
                });
            },

            // --- Enhanced Tab Switching ---
            switchTab(tab) {
                if(this.data.isLocked) {
                    this.showToast('System Locked', 'error');
                    return;
                }

                if(this.data.activeTab === tab) return;

                this.data.activeTab = tab;
                localStorage.setItem('hr_active_tab', tab);

                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));

                const btnId = 'btn-tab-' + tab;
                const viewId = 'view-' + tab;

                const btn = document.getElementById(btnId);
                const view = document.getElementById(viewId);
                
                if(btn && view) {
                    btn.classList.add('active');
                    view.classList.add('active');
                    
                    if(tab === 'attendance') this.renderTable();
                    if(tab === 'schedule') this.renderSchedule();
                    if(tab === 'requests') this.renderRequests();
                    if(tab === 'summary') this.renderSummary();
                }
                
                Logger.log('info', `Switched to ${tab} tab`, 'Navigation');
            },
            
            // --- Enhanced Print Functionality ---
            async printContent() {
                this.loadingManager.show('Preparing print document...');
                
                try {
                    const printContainer = document.getElementById('printContainer');
                    const t = CONFIG.translations[this.data.lang];
                    
                    // Header
                    const header = `
                        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid var(--primary); padding-bottom: 20px;">
                            <h1 style="font-size: 24px; font-weight: 700; margin-bottom: 10px;">HR Master v6.1</h1>
                            <p style="font-size: 14px; color: #666;">Printed on: ${new Date().toLocaleString()}</p>
                        </div>`;

                    let content = '';
                    const activeTab = this.data.activeTab;

                    if(activeTab === 'attendance' || activeTab === 'summary') {
                        const daysInMonth = new Date(this.data.currentYear, this.data.currentMonth + 1, 0).getDate();
                        
                        // Header Row
                        content += `<thead><tr>
                            <th class="print-th">No</th>
                            <th class="print-th">${t.col_name}</th>
                            <th class="print-th">${t.col_work}</th>
                            <th class="print-th">${t.col_absent}</th>
                            <th class="print-th">${t.col_vac}</th>
                            <th class="print-th">${t.col_sick}</th>
                            <th class="print-th">${t.col_tot_days}</th>
                            <th class="print-th">${t.col_ot_hours}</th>
                            <th class="print-th">${t.col_ot_days}</th>
                            <th class="print-th">${t.col_tot_ot}</th>
                        </tr></thead>`;
                        
                        // Body Rows
                        content += `<tbody>`;
                        this.data.employees.forEach((emp, index) => {
                            let workingDays = 0, absentDays = 0, vacationDays = 0, sickDays = 0, overtimeHours = 0, overtimeDays = 0;
                            
                            for(let i=1; i<=daysInMonth; i++) {
                                const att = this.getAttendance(emp.id, i);
                                if(att) {
                                    if(att.status === 'present' || att.status === 'overtime') {
                                        workingDays++;
                                        if(att.hours > 9) {
                                            overtimeHours += (att.hours - 9);
                                            overtimeDays++;
                                        }
                                    } else if (att.status === 'absent') {
                                        absentDays++;
                                    } else if (att.status === 'vacation') {
                                        vacationDays++;
                                    } else if (att.status === 'sick') {
                                        sickDays++;
                                    }
                                } else {
                                    workingDays++;
                                }
                            }
                            
                            const totalDays = workingDays + absentDays + vacationDays + sickDays;
                            const totalOverTime = overtimeHours;
                            
                            content += `
                            <tr>
                                <td class="print-td">${index + 1}</td>
                                <td class="print-td">${emp.name}</td>
                                <td class="print-td">${workingDays}</td>
                                <td class="print-td" style="background:#fee2e2;">${absentDays}</td>
                                <td class="print-td" style="background:#fef3c7;">${vacationDays}</td>
                                <td class="print-td" style="background:#ede9fe;">${sickDays}</td>
                                <td class="print-td"><strong>${totalDays}</strong></td>
                                <td class="print-td" style="color:#b45309;">${overtimeHours}</td>
                                <td class="print-td">${overtimeDays}</td>
                                <td class="print-td"><strong>${totalOverTime}</strong></td>
                            </tr>`;
                        });
                        content += `</tbody>`;
                        
                        const tableHtml = `
                            <div class="arabic-header">${t.header_period}</div>
                            <table class="print-table">
                                ${content}
                            </table>
                        `;
                        
                        printContainer.innerHTML = header + tableHtml;

                    } else if (activeTab === 'schedule') {
                        const view = document.getElementById('view-schedule');
                        const cloned = view.cloneNode(true);
                        cloned.querySelectorAll('.no-print, .btn').forEach(e => e.remove());
                        cloned.querySelectorAll('table').forEach(t => {
                            t.style.width = '100%';
                            t.classList.add('print-table');
                            t.querySelectorAll('th, td').forEach(c => c.classList.add('print-th', 'print-td'));
                        });
                        printContainer.innerHTML = header + cloned.outerHTML;
                    } else if (activeTab === 'requests') {
                        const view = document.getElementById('view-requests');
                        const cloned = view.cloneNode(true);
                        cloned.querySelectorAll('.no-print, .btn').forEach(e => e.remove());
                        cloned.querySelectorAll('table').forEach(t => {
                            t.style.width = '100%';
                            t.classList.add('print-table');
                            t.querySelectorAll('th, td').forEach(c => c.classList.add('print-th', 'print-td'));
                        });
                        printContainer.innerHTML = header + cloned.outerHTML;
                    }

                    // Footer
                    const footer = `
                        <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #888; border-top: 1px solid #ccc; padding-top: 10px;">
                            ${t.col_emp} ${this.data.employees.length} | ${t.header_period}: ${new Date().toLocaleString()} | HR Master v6.1
                        </div>`;
                    
                    printContainer.innerHTML += footer;

                    // Trigger Print
                    setTimeout(() => {
                        window.print();
                        setTimeout(() => {
                            printContainer.innerHTML = '';
                            this.loadingManager.hide();
                        }, 1000);
                    }, 500);
                    
                    Logger.log('info', `Printed ${activeTab} view`, 'PrintManager');
                } catch (error) {
                    Logger.log('error', 'Print failed', 'PrintManager');
                    ErrorHandler.show(error, 'Print');
                    this.loadingManager.hide();
                }
            },
            
            async exportToExcel() {
                if (typeof XLSX === 'undefined') {
                    this.showToast('Excel library not loaded', 'warning');
                    return;
                }
                
                this.loadingManager.show('Exporting to Excel...');
                
                try {
                    const wb = XLSX.utils.book_new();
                    const wsData = [];
                    
                    // Headers
                    if(this.data.lang === 'ar') {
                        wsData.push(['اسم الموظف', 'رقم الوظيفة', 'أيام العمل', 'أيام الغياب', 'أيام الإجازة', 'أيام المرض', 'إجمالي الأيام', 'ساعات العمل الإضافية', 'أيام العمل الإضافية', 'إجمالي العمل الإضافي']);
                    } else {
                        wsData.push(['Employee Name', 'Job Number', 'Working Days', 'Absent Days', 'Vacation Days', 'Sick Days', 'Total Days', 'Overtime Hours', 'Overtime Days', 'Total Overtime']);
                    }
                    
                    // Data
                    const daysInMonth = new Date(this.data.currentYear, this.data.currentMonth + 1, 0).getDate();
                    this.data.employees.forEach(emp => {
                        let workingDays = 0, absentDays = 0, vacationDays = 0, sickDays = 0;
                        let overtimeHours = 0, overtimeDays = 0;
                        
                        for (let i = 1; i <= daysInMonth; i++) {
                            const att = this.getAttendance(emp.id, i);
                            if (att) {
                                if (att.status === 'present' || att.status === 'overtime') {
                                    workingDays++;
                                    if (att.hours > 9) {
                                        overtimeHours += (att.hours - 9);
                                        overtimeDays++;
                                    }
                                } else if (att.status === 'absent') {
                                    absentDays++;
                                } else if (att.status === 'vacation') {
                                    vacationDays++;
                                } else if (att.status === 'sick') {
                                    sickDays++;
                                }
                            } else {
                                workingDays++;
                            }
                        }
                        
                        const totalDays = workingDays + absentDays + vacationDays + sickDays;
                        const totalOverTime = overtimeHours;
                        wsData.push([emp.name, emp.jobNumber || '', workingDays, absentDays, vacationDays, sickDays, totalDays, overtimeHours, overtimeDays, totalOverTime]);
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    ws['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 15 }, { wch: 12 }, { wch: 15 }];
                    XLSX.utils.book_append_sheet(wb, ws, 'Monthly Summary');
                    const fileName = `HR_Summary_${this.data.currentYear}_${this.data.currentMonth + 1}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    this.showToast('Excel file exported successfully', 'success');
                    Logger.log('info', 'Excel export completed', 'ExportManager');
                } catch (error) {
                    Logger.log('error', 'Excel export failed', 'ExportManager');
                    ErrorHandler.show(error, 'Excel Export');
                } finally {
                    this.loadingManager.hide();
                }
            },
            
            async exportToCSV() {
                this.loadingManager.show('Exporting to CSV...');
                
                try {
                    let csvContent = "data:text/csv;charset=utf-8,";
                    
                    // Headers
                    if(this.data.lang === 'ar') {
                         csvContent += "اسم الموظف,رقم الوظيفة,أيام العمل,أيام الغياب,أيام الإجازة,أيام المرض,إجمالي الأيام,ساعات العمل الإضافية,أيام العمل الإضافية,إجمالي العمل الإضافي\n";
                    } else {
                        csvContent += "Employee Name,Job Number,Working Days,Absent Days,Vacation Days,Sick Days,Total Days,Overtime Hours,Overtime Days,Total Overtime\n";
                    }

                    // Data
                    const daysInMonth = new Date(this.data.currentYear, this.data.currentMonth + 1, 0).getDate();
                    this.data.employees.forEach(emp => {
                        let workingDays = 0, absentDays = 0, vacationDays = 0, sickDays = 0;
                        let overtimeHours = 0, overtimeDays = 0;
                        
                        for (let i = 1; i <= daysInMonth; i++) {
                            const att = this.getAttendance(emp.id, i);
                            if (att) {
                                if (att.status === 'present' || att.status === 'overtime') {
                                    workingDays++;
                                    if (att.hours > 9) {
                                        overtimeHours += (att.hours - 9);
                                        overtimeDays++;
                                    }
                                } else if (att.status === 'absent') {
                                    absentDays++;
                                } else if (att.status === 'vacation') {
                                    vacationDays++;
                                } else if (att.status === 'sick') {
                                    sickDays++;
                                }
                            } else {
                                workingDays++;
                            }
                        }
                        
                        const totalDays = workingDays + absentDays + vacationDays + sickDays;
                        const totalOverTime = overtimeHours;
                        csvContent += [`"${emp.name}"`, `"${emp.jobNumber || ''}"`, workingDays, absentDays, vacationDays, sickDays, totalDays, overtimeHours, overtimeDays, totalOverTime].join(',');
                        csvContent += "\n";
                    });
                    
                    // Create download
                    const link = document.createElement("a");
                    link.setAttribute("href", encodeURI(csvContent));
                    link.setAttribute("download", `HR_Summary_${this.data.currentYear}_${this.data.currentMonth + 1}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.showToast('CSV file exported successfully', 'success');
                    Logger.log('info', 'CSV export completed', 'ExportManager');
                } catch (error) {
                    Logger.log('error', 'CSV export failed', 'ExportManager');
                    ErrorHandler.show(error, 'CSV Export');
                } finally {
                    this.loadingManager.hide();
                }
            },
            
            // --- Employee Profile Print ---
            printEmployeeProfile() {
                const id = document.getElementById('editEmpId').value;
                if(!id) { this.showToast('Save employee first', 'error'); return; }
                const emp = this.data.employees.find(e => e.id == id);
                if(!emp) { this.showToast('Employee not found', 'error'); return; }
                const printArea = document.getElementById('printEmployeeArea');
                const t = CONFIG.translations[this.data.lang];
                
                printArea.innerHTML = `
                    <div style="max-width: 800px; margin: 0 auto;">
                        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #3b82f6; padding-bottom: 20px;">
                            <h1 style="font-size: 28px; font-weight: 700; color: #333; margin-bottom: 10px;">${t.modal_emp_file}</h1>
                            <p style="font-size: 14px; color: #666;">${t.header_period}: ${new Date().toLocaleDateString()}</p>
                        </div>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 0 0 180px; text-align: center;">
                                <img src="${emp.photo || 'https://via.placeholder.com/150'}" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid #eee; margin-bottom: 15px;">
                            </div>
                            
                            <div style="flex: 1;">
                                <h2 style="font-size: 24px; font-weight: 700; margin-bottom: 15px; color: #333;">${emp.name}</h2>
                                <p style="font-size: 16px; margin-bottom: 10px;"><strong>${t.lbl_job_no}:</strong> ${emp.jobNumber || 'N/A'}</p>
                                
                                <div style="margin-bottom: 20px;">
                                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #555;">${t.hdr_personal_info}</h3>
                                    <p style="font-size: 14px; margin-bottom: 5px;"><strong>${t.lbl_phone}:</strong> ${emp.phone || 'N/A'}</p>
                                    <p style="font-size: 14px; margin-bottom: 5px;"><strong>${t.lbl_nat}:</strong> ${emp.nationality || 'N/A'}</p>
                                </div>
                                
                                <div>
                                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #555;">${t.hdr_compliance}</h3>
                                    <p style="font-size: 14px; margin-bottom: 5px;"><strong>${t.lbl_pass_no}:</strong> ${emp.passportNo || 'N/A'} ${emp.passportExp ? `(${t.lbl_pass_exp}: ${new Date(emp.passportExp).toLocaleDateString()})` : ''}</p>
                                    <p style="font-size: 14px; margin-bottom: 5px;"><strong>${t.lbl_eid_no}:</strong> ${emp.eidNo || 'N/A'} ${emp.eidExp ? `(${t.lbl_eid_exp}: ${new Date(emp.eidExp).toLocaleDateString()})` : ''}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #555;">${t.hdr_hr_settings}</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div><p style="font-size: 14px; margin-bottom: 5px;"><strong>${t.lbl_join_date}:</strong> ${emp.joinDate ? new Date(emp.joinDate).toLocaleDateString() : 'N/A'}</p></div>
                                <div><p style="font-size: 14px; margin-bottom: 5px;"><strong>${t.lbl_weekly_off}:</strong> ${this.getWeekdayName(parseInt(emp.weeklyOff))}</p></div>
                                <div><p style="font-size: 14px; margin-bottom: 5px;"><strong>${t.lbl_pass_exp}:</strong> ${emp.passportExp ? new Date(emp.passportExp).toLocaleDateString() : 'N/A'}</p></div>
                                <div><p style="font-size: 14px; margin-bottom: 5px;"><strong>${t.lbl_eid_exp}:</strong> ${emp.eidExp ? new Date(emp.eidExp).toLocaleDateString() : 'N/A'}</p></div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #888;">
                            HR Master v6.1
                        </div>
                    </div>
                `;
                document.body.appendChild(printArea);
                setTimeout(() => {
                    window.print();
                    setTimeout(() => {
                        document.body.removeChild(printArea);
                    }, 500);
                }, 500);
                
                Logger.log('info', `Printed employee profile: ${emp.name}`, 'PrintManager');
            },
            
            getWeekdayName(dayIndex) {
                const days = ['None', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                return days[parseInt(dayIndex) + 1] || 'None';
            },
            
            // --- Toast Notification System ---
            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                document.getElementById('toastMsg').innerText = message;
                const icon = toast.querySelector('i');
                if (type === 'success') { icon.className = 'fas fa-check-circle'; toast.className = 'toast success show'; }
                else if (type === 'error') { icon.className = 'fas fa-exclamation-circle'; toast.className = 'toast error show'; }
                else if (type === 'info') { icon.className = 'fas fa-info-circle'; toast.className = 'toast info show'; }
                
                setTimeout(() => toast.classList.remove('show'), 3000);
            },
            
            // --- Requests Logic ---
            handleReqSearch() {
                this.data.reqSearchTerm = document.getElementById('reqSearchInput').value.toLowerCase();
                this.renderRequests();
            },

            renderRequests() {
                const tbody = document.getElementById('requestsBody');
                if(this.data.requests.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px; color:var(--text-muted);">${this.data.lang==='ar'?'لا توجد طلبات':'No leave requests found'}.</td></tr>`;
                    return;
                }
                const filtered = this.data.requests.filter(req => {
                    const emp = this.data.employees.find(e => e.id == req.empId);
                    if(!emp) return false;
                    return emp.name.toLowerCase().includes(this.data.reqSearchTerm) || req.type.toLowerCase().includes(this.data.reqSearchTerm);
                });
                
                const t = CONFIG.translations[this.data.lang];
                
                tbody.innerHTML = filtered.map(req => {
                    const emp = this.data.employees.find(e => e.id == req.empId) || {name:'Unknown', photo:''};
                    let badge = `<span class="status-badge status-pending">${t.status_pending}</span>`;
                    let actions = `<button class="btn btn-success" style="padding:4px 8px; font-size:11px;" onclick="app.handleRequest(${req.id}, 'approved')">${t.btn_approve}</button> <button class="btn btn-danger" style="padding:4px 8px; font-size:11px;" onclick="app.handleRequest(${req.id}, 'rejected')">${t.btn_reject}</button>`;
                    
                    if(req.status === 'approved') {
                        badge = `<span class="status-badge status-approved">${t.status_approved}</span>`;
                        actions = `<i class="fas fa-check" style="color:var(--success)"></i>`;
                    } else if(req.status === 'rejected') {
                        badge = `<span class="status-badge status-rejected">${t.status_rejected}</span>`;
                        actions = `<i class="fas fa-times" style="color:var(--secondary)"></i>`;
                    }
                    
                    const sDate = new Date(req.startDate).toLocaleDateString();
                    const eDate = new Date(req.endDate).toLocaleDateString();
                    
                    return `
                    <tr>
                        <td>
                            <div class="emp-cell" onclick="app.openEmployeeModal(${req.empId})">
                                <img src="${emp.photo || 'https://via.placeholder.com/36'}" class="emp-avatar">
                                <div class="emp-info">
                                    <span class="emp-name">${emp.name}</span>
                                    <span class="emp-meta">${emp.jobNumber || 'N/A'}</span>
                                </div>
                            </div>
                        </td>
                        <td>${req.type === 'vacation' ? '<i class="fas fa-umbrella-beach" style="color:var(--primary)"></i> '+t.vacation : '<i class="fas fa-ban" style="color:var(--secondary)"></i> '+t.unpaid}</td>
                        <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${req.reason}">${req.reason}</td>
                        <td>${sDate} <br>to<br> ${eDate}</td>
                        <td style="font-weight:700;">${req.duration} ${t.lbl_days}</td>
                        <td>${badge}</td>
                        <td style="text-align:center;">${actions}</td>
                    </tr>`;
                }).join('');
            },
            
            openRequestModal() {
                const sel = document.getElementById('reqEmpSelect');
                sel.innerHTML = this.data.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                document.getElementById('reqType').value = 'vacation';
                document.getElementById('reqDuration').value = 1;
                document.getElementById('reqStart').valueAsDate = new Date();
                this.calculateReturnDate();
                document.getElementById('requestModal').classList.add('active');
            },
            
            calculateReturnDate() {
                const startStr = document.getElementById('reqStart').value;
                const duration = parseInt(document.getElementById('reqDuration').value) || 0;
                if(startStr && duration > 0) {
                    const start = new Date(startStr);
                    const end = new Date(start);
                    end.setDate(start.getDate() + duration);
                    document.getElementById('reqEndCalc').value = end.toISOString().split('T')[0];
                    document.getElementById('reqReturnDisplay').value = end.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
                } else {
                    document.getElementById('reqReturnDisplay').value = '';
                    document.getElementById('reqEndCalc').value = '';
                }
            },
            
            submitRequest() {
                const empId = document.getElementById('reqEmpSelect').value;
                const type = document.getElementById('reqType').value;
                const start = document.getElementById('reqStart').value;
                const end = document.getElementById('reqEndCalc').value;
                const duration = document.getElementById('reqDuration').value;
                const reason = document.getElementById('reqReason').value;
                const t = CONFIG.translations[this.data.lang];
                
                if(!start || !end) return this.showToast('Required fields missing', 'error');
                
                const req = {
                    id: Date.now(),
                    empId: parseInt(empId),
                    type, startDate: start, endDate: end, duration, reason, status: 'pending'
                };
                this.data.requests.push(req);
                this.saveData();
                this.renderRequests();
                this.closeModals();
                this.showToast(t.toast_sub, 'success');
                Logger.log('info', `Leave request submitted for employee ${empId}`, 'RequestManager');
            },
            
            handleRequest(id, status) {
                const req = this.data.requests.find(r => r.id == id);
                if(!req) return;
                req.status = status;
                if(status === 'approved') this.applyLeaveToAttendance(req);
                this.saveData();
                this.renderRequests();
                this.renderTable();
                const t = CONFIG.translations[this.data.lang];
                this.showToast(`${status === 'approved' ? t.toast_approved : t.toast_rejected}`, status === 'approved' ? 'success' : 'error');
                Logger.log('info', `Request ${id} ${status}`, 'RequestManager');
            },
            
            applyLeaveToAttendance(req) {
                const sDate = new Date(req.startDate + 'T00:00:00');
                const eDate = new Date(req.endDate + 'T00:00:00');
                const iter = new Date(sDate);
                while(iter <= eDate) {
                    const day = iter.getDate();
                    const month = iter.getMonth();
                    const year = iter.getFullYear();
                    const k = `${year}_${month}`;
                    
                    if(!this.data.attendance[k]) this.data.attendance[k] = {};
                    if(!this.data.attendance[k][req.empId]) this.data.attendance[k][req.empId] = {};
                    this.data.attendance[k][req.empId][day] = {status: req.type, hours: 0};
                    iter.setDate(iter.getDate() + 1);
                }
            },
            
            // --- Schedule Logic ---
            renderSchedule() {
                const tbody = document.getElementById('scheduleBody');
                if(this.data.employees.length === 0) { 
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Add employees first</td></tr>`; 
                    return; 
                }
                const t = CONFIG.translations[this.data.lang];
                
                tbody.innerHTML = this.data.employees.map(emp => {
                    const empSch = this.data.schedule[emp.id] || {};
                    let cells = '';
                    const days = [t.day_sun, t.day_mon, t.day_tue, t.day_wed, t.day_thu, t.day_fri, t.day_sat];
                    days.forEach((dayName, idx) => {
                        const shift = empSch[idx];
                        let html = `<div class="shift-cell" onclick="app.openShiftModal(${emp.id}, ${idx}, '${dayName}')">`;
                        if(!shift || shift.off) { html += `<span class="off-day">${t.lbl_off}</span>`; }
                        else {
                            html += `<span class="shift-time">${this.formatTime(shift.s1)} - ${this.formatTime(shift.e1)}</span>`;
                            if(shift.s2 && shift.e2) html += `<span class="split-sep">/</span><span class="shift-time">${this.formatTime(shift.s2)} - ${this.formatTime(shift.e2)}</span>`;
                        }
                        html += `</div>`;
                        cells += `<td>${html}</td>`;
                    });
                    return `<tr>
                        <td>
                            <div class="emp-cell" onclick="app.openEmployeeModal(${emp.id})">
                                <img src="${emp.photo || 'https://via.placeholder.com/36'}" class="emp-avatar">
                                <div class="emp-info"><span class="emp-name">${emp.name}</span><span class="emp-meta">${emp.jobNumber||'N/A'}</span></div></div>
                            </div>
                        </td>${cells}</tr>`;
                }).join('');
            },
            
            formatTime(time24) {
                if(!time24) return "";
                const [h, m] = time24.split(':');
                return `${parseInt(h)%12||12}:${m} ${parseInt(h)>=12?'PM':'AM'}`;
            },
            
            openShiftModal(empId, dayIdx, dayName) {
                const emp = this.data.employees.find(e => e.id === empId);
                const shift = this.data.schedule[emp.id]?.[dayIdx];
                document.getElementById('shiftEmpName').value = emp.name;
                document.getElementById('shiftDayName').value = dayName;
                document.getElementById('shiftModal').dataset.empId = empId;
                document.getElementById('shiftModal').dataset.dayIdx = dayIdx;
                
                if(shift && shift.off) {
                    document.getElementById('shiftOffDay').checked = true;
                    this.toggleShiftInputs();
                } else {
                    document.getElementById('shiftOffDay').checked = false;
                    document.getElementById('shiftStart1').value = shift ? shift.s1 : "";
                    document.getElementById('shiftEnd1').value = shift ? shift.e1 : "";
                    document.getElementById('shiftStart2').value = shift ? (shift.s2 || "") : "";
                    document.getElementById('shiftEnd2').value = shift ? (shift.e2 || "") : "";
                    this.toggleShiftInputs();
                }
                document.getElementById('shiftModal').classList.add('active');
            },
            
            toggleShiftInputs() {
                const isOff = document.getElementById('shiftOffDay').checked;
                document.getElementById('primaryShiftGroup').style.display = isOff ? 'none' : 'grid';
                document.getElementById('secondaryShiftGroup').style.display = isOff ? 'none' : 'block';
            },
            
            saveShift(isClear) {
                const empId = document.getElementById('shiftModal').dataset.empId;
                const dayIdx = parseInt(document.getElementById('shiftModal').dataset.dayIdx);
                if(!this.data.schedule[empId]) this.data.schedule[empId] = {};
                if(isClear || document.getElementById('shiftOffDay').checked) {
                    this.data.schedule[empId][dayIdx] = { off: true };
                } else {
                    const s1 = document.getElementById('shiftStart1').value;
                    const e1 = document.getElementById('shiftEnd1').value;
                    const s2 = document.getElementById('shiftStart2').value;
                    const e2 = document.getElementById('shiftEnd2').value;
                    if(!s1 || !e1) return this.showToast('Required fields missing', 'error');
                    this.data.schedule[empId][dayIdx] = { s1, e1, s2, e2 };
                }
                this.saveData();
                this.renderSchedule();
                this.closeModals();
                this.showToast(CONFIG.translations[this.data.lang].toast_success, 'success');
                Logger.log('info', `Shift saved for employee ${empId}`, 'ScheduleManager');
            },
            
            // --- Attendance Logic with Pagination ---
            renderTable() {
                const daysInMonth = new Date(this.data.currentYear, this.data.currentMonth + 1, 0).getDate();
                const tbody = document.getElementById('tableBody');
                const thead = document.getElementById('tableHeader');
                const t = CONFIG.translations[this.data.lang];
                
                // Build header
                let h = `<th>${t.col_emp_details}</th>`;
                for(let i=1; i<=daysInMonth; i++) {
                    const d = new Date(this.data.currentYear, this.data.currentMonth, i);
                    h += `<th style="min-width:40px;">${i}<br><span style="font-size:10px; opacity:0.7;">${d.toLocaleDateString('en-US',{weekday:'narrow'})}</span></th>`;
                }
                thead.innerHTML = h;
                
                // Filter and paginate
                const filtered = this.data.employees.filter(e => 
                    e.name.toLowerCase().includes(this.data.searchTerm) || 
                    (e.jobNumber && e.jobNumber.toString().includes(this.data.searchTerm))
                );
                
                this.paginationManager.setData(filtered);
                const pageData = this.paginationManager.getPage();
                
                // Render page data
                tbody.innerHTML = pageData.map(emp => {
                    let worked=0, ot=0, cells='';
                    for(let i=1; i<=daysInMonth; i++) {
                        const att = this.getAttendance(emp.id, i);
                        let content = '-', cls = '';
                        if(att) {
                            if(att.status==='present' || att.status==='overtime') {
                                content=att.hours; worked++;
                                if(att.hours>9) { cls='status-overtime'; ot+=att.hours-9; }
                                else cls='status-present';
                            } else if(att.status==='weeklyoff') { content='W'; cls='status-weeklyoff'; }
                            else if(att.status==='vacation') { content='V'; cls='status-vacation'; }
                            else if(att.status==='unpaid') { content='U'; cls='status-unpaid'; }
                            else if(att.status==='sick') { content='S'; cls='status-sick'; }
                            else if(att.status==='absent') { content='A'; cls='status-absent'; }
                        }
                        if(cls==='status-present') cls='background:#dcfce7; color:#166534';
                        if(cls==='status-overtime') cls='background:#cffafe; color:#0e7490; border:2px solid #06b6d4; font-weight:700;';
                        if(cls==='status-vacation') cls='background:#fef3c7; color:#92400e';
                        if(cls==='status-unpaid') cls='background:#f1f5f9; color:#64748b; border:1px solid #cbd5e1';
                        if(cls==='status-sick') cls='background:#ede9fe; color:#5b21b6';
                        if(cls==='status-weeklyoff') cls='background:#dbeafe; color:#1e40af';
                        cells += `<td class="day-cell" style="${cls}" onclick="app.openAttendanceModal(${emp.id},${i})">${content}</td>`;
                    }
                    return `<tr>
                        <td>
                            <div class="emp-cell" onclick="app.openEmployeeModal(${emp.id})">
                                <img src="${emp.photo||'https://via.placeholder.com/36'}" class="emp-avatar">
                                <div><div class="emp-name">${emp.name}</div><div class="emp-meta">${emp.jobNumber}</div></div>
                            </div>
                        </td>
                        ${cells}
                        <td style="font-weight:bold">${worked}</td>
                        <td style="color:${ot>0?'var(--primary)':'inherit'}">${ot>0?'+'+ot:'-'}</td>
                    </tr>`;
                }).join('');
                
                // Update pagination controls
                this.updatePaginationControls();
            },
            
            updatePaginationControls() {
                const pagination = document.getElementById('attendancePagination');
                const pageInfo = document.getElementById('paginationInfo');
                const pageNumbers = document.getElementById('pageNumbers');
                
                // Update info
                pageInfo.textContent = `Page ${this.paginationManager.currentPage} of ${this.paginationManager.totalPages} (${this.paginationManager.totalItems} items)`;
                
                // Update buttons
                document.getElementById('firstPageBtn').disabled = this.paginationManager.currentPage === 1;
                document.getElementById('prevPageBtn').disabled = this.paginationManager.currentPage === 1;
                document.getElementById('nextPageBtn').disabled = this.paginationManager.currentPage === this.paginationManager.totalPages;
                document.getElementById('lastPageBtn').disabled = this.paginationManager.currentPage === this.paginationManager.totalPages;
                
                // Update page numbers
                pageNumbers.innerHTML = '';
                const maxVisible = 5;
                let start = Math.max(1, this.paginationManager.currentPage - Math.floor(maxVisible / 2));
                let end = Math.min(this.paginationManager.totalPages, start + maxVisible - 1);
                
                if (end - start < maxVisible - 1) {
                    start = Math.max(1, end - maxVisible + 1);
                }
                
                for (let i = start; i <= end; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    btn.className = i === this.paginationManager.currentPage ? 'active' : '';
                    btn.onclick = () => {
                        this.paginationManager.goToPage(i);
                        this.renderTable();
                    };
                    pageNumbers.appendChild(btn);
                }
            },
            
            getAttendance(id, day) {
                const k = `${this.data.currentYear}_${this.data.currentMonth}`;
                return (this.data.attendance[k]?.[id]?.[day]) || null;
            },
            
            openAttendanceModal(id, day) {
                const e = this.data.employees.find(x=>x.id===id);
                const a = this.getAttendance(id, day);
                const t = CONFIG.translations[this.data.lang];
                
                document.getElementById('modalEmpName').value = e.name;
                document.getElementById('modalDate').value = `${day} ${document.getElementById('monthSelect').value} ${this.data.currentYear}`;
                document.getElementById('modalEmpId').value=id; document.getElementById('modalDay').value=day;
                document.getElementById('modalStatus').value = a ? a.status : 'present';
                document.getElementById('modalHours').value = a ? a.hours : 9;
                this.toggleHoursInput();
                document.getElementById('attendanceModal').classList.add('active');
            },
            
            toggleHoursInput() {
                document.getElementById('hoursGroup').style.display = (['present','overtime','unpaid'].includes(document.getElementById('modalStatus').value)) ? 'block' : 'none';
            },
            
            saveAttendance() {
                if(this.data.isLocked) return this.showToast('System Locked', 'error');
                
                const id = parseInt(document.getElementById('modalEmpId').value);
                const day = parseInt(document.getElementById('modalDay').value);
                const status = document.getElementById('modalStatus').value;
                const hours = status==='present'||status==='overtime' ? parseFloat(document.getElementById('modalHours').value) : 0;
                const k = `${this.data.currentYear}_${this.data.currentMonth}`;
                if(!this.data.attendance[k]) this.data.attendance[k]={};
                if(!this.data.attendance[k][id]) this.data.attendance[k][id]={};
                this.data.attendance[k][id][day]={ status, hours };
                this.saveData(); 
                this.renderTable(); 
                this.renderSummary();
                this.closeModals(); 
                this.showToast(CONFIG.translations[this.data.lang].toast_success, 'success');
                Logger.log('info', `Attendance saved for employee ${id}, day ${day}`, 'AttendanceManager');
            },
            
            // --- Bulk & OT ---
            openBulkModal() {
                const s = document.getElementById('bulkEmpSelect');
                s.innerHTML = '<option value="all">ALL</option>'+this.data.employees.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
                const dim = new Date(this.data.currentYear, this.data.currentMonth+1, 0).getDate();
                document.getElementById('bulkStart').value=`${this.data.currentYear}-${String(this.data.currentMonth+1).padStart(2,'0')}-01`;
                document.getElementById('bulkEnd').value=`${this.data.currentYear}-${String(this.data.currentMonth+1).padStart(2,'0')}-${dim}`;
                document.getElementById('bulkModal').classList.add('active');
            },
            
            applyBulkAction() {
                if(this.data.isLocked) return this.showToast('System Locked', 'error');
                
                const eid = document.getElementById('bulkEmpSelect').value;
                const status = document.getElementById('bulkStatus').value;
                const start = new Date(document.getElementById('bulkStart').value);
                const end = new Date(document.getElementById('bulkEnd').value);
                if(end<start) return this.showToast('Invalid date range', 'error');
                const targets = eid==='all' ? this.data.employees : this.data.employees.filter(e=>e.id==eid);
                const k = `${this.data.currentYear}_${this.data.currentMonth}`;
                if(!this.data.attendance[k]) this.data.attendance[k]={};
                let d = new Date(start);
                while(d<=end) {
                    if(d.getMonth()===this.data.currentMonth) {
                        const day = d.getDate();
                        targets.forEach(e => {
                            if(!this.data.attendance[k][e.id]) this.data.attendance[k][e.id]={};
                            this.data.attendance[k][e.id][day]={status, hours:0};
                        });
                    }
                    d.setDate(d.getDate()+1);
                }
                this.saveData(); 
                this.renderTable(); 
                this.renderSummary(); 
                this.closeModals(); 
                this.showToast(CONFIG.translations[this.data.lang].toast_success, 'success');
                Logger.log('info', `Bulk action applied: ${status}`, 'BulkManager');
            },
            
            openOTModal() {
                const s = document.getElementById('otEmpSelect');
                s.innerHTML = '<option value="all">ALL</option>'+this.data.employees.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
                const dim = new Date(this.data.currentYear, this.data.currentMonth+1, 0).getDate();
                document.getElementById('otStart').value=`${this.data.currentYear}-${String(this.data.currentMonth+1).padStart(2,'0')}-01`;
                document.getElementById('otEnd').value=`${this.data.currentYear}-${String(this.data.currentMonth+1).padStart(2,'0')}-${dim}`;
                document.getElementById('otModal').classList.add('active');
            },
            
            applyQuickOT() {
                if(this.data.isLocked) return this.showToast('System Locked', 'error');
                
                const eid = document.getElementById('otEmpSelect').value;
                const val = parseFloat(document.getElementById('otHours').value);
                const start = new Date(document.getElementById('otStart').value);
                const end = new Date(document.getElementById('otEnd').value);
                const targets = eid==='all' ? this.data.employees : this.data.employees.filter(e=>e.id==eid);
                const k = `${this.data.currentYear}_${this.data.currentMonth}`;
                if(!this.data.attendance[k]) this.data.attendance[k]={};
                let d = new Date(start);
                while(d<=end) {
                    if(d.getMonth()===this.data.currentMonth) {
                        const day = d.getDate();
                        targets.forEach(e => {
                            if(!this.data.attendance[k][e.id]) this.data.attendance[k][e.id]={};
                            const curr = this.data.attendance[k][e.id][day];
                            if(!curr || curr.status==='present'||curr.status==='overtime') {
                                let h = ((curr?curr.hours:9)+val);
                                this.data.attendance[k][e.id][day]={status:'present', hours:h};
                            }
                        });
                    }
                    d.setDate(d.getDate()+1);
                }
                this.saveData(); 
                this.renderTable(); 
                this.renderSummary(); 
                this.closeModals(); 
                this.showToast(CONFIG.translations[this.data.lang].toast_success, 'success');
                Logger.log('info', `OT applied: ${val} hours`, 'OTManager');
            },
            
            // --- Utils ---
            loadData() {
                try {
                    const e = localStorage.getItem(CONFIG.storageKeys.employees); 
                    if(e) this.data.employees = JSON.parse(e);
                    const a = localStorage.getItem(CONFIG.storageKeys.data); 
                    if(a) this.data.attendance = JSON.parse(a);
                    const s = localStorage.getItem(CONFIG.storageKeys.schedule); 
                    if(s) this.data.schedule = JSON.parse(s);
                    const r = localStorage.getItem(CONFIG.storageKeys.requests); 
                    if(r) this.data.requests = JSON.parse(r);
                    
                    // Restore last active tab
                    const lastTab = localStorage.getItem('hr_active_tab');
                    if(lastTab) this.data.activeTab = lastTab;
                    
                    Logger.log('info', 'Data loaded successfully', 'DataManager');
                } catch (err) {
                    console.error("Data corrupted, resetting...", err);
                    Logger.log('error', 'Data Corrupted. Resetting LocalStorage.', 'DataManager');
                    localStorage.clear();
                    location.reload();
                }
            },
            
            saveData() {
                try {
                    localStorage.setItem(CONFIG.storageKeys.employees, JSON.stringify(this.data.employees));
                    localStorage.setItem(CONFIG.storageKeys.data, JSON.stringify(this.data.attendance));
                    localStorage.setItem(CONFIG.storageKeys.schedule, JSON.stringify(this.data.schedule));
                    localStorage.setItem(CONFIG.storageKeys.requests, JSON.stringify(this.data.requests));
                    
                    // Cache last save
                    this.cacheManager.set('lastSave', new Date().toISOString());
                } catch (error) {
                    Logger.log('error', 'Failed to save data', 'DataManager');
                    ErrorHandler.show(error, 'Data Save');
                }
            },
            
            toggleTheme() {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem(CONFIG.storageKeys.theme, document.body.classList.contains('dark-mode') ? 'dark' : 'light');
                document.getElementById('themeIcon').className = document.body.classList.contains('dark-mode') ? 'fas fa-sun' : 'fas fa-moon';
            },
            
            loadTheme() { 
                const theme = localStorage.getItem(CONFIG.storageKeys.theme);
                if(theme === 'dark') { 
                    document.body.classList.add('dark-mode'); 
                    document.getElementById('themeIcon').className = 'fas fa-sun'; 
                }
            },
            
            handleSearch() { 
                this.data.searchTerm = document.getElementById('searchInput').value.toLowerCase(); 
                this.renderTable(); 
            },
            
            renderDateSelectors() {
                const m = ["January","February","March","April","May","June","July","August","September","October","November","December"];
                document.getElementById('monthSelect').innerHTML = m.map((nm,i) => `<option value="${i}" ${i===this.data.currentMonth?'selected':''}>${nm}</option>`).join('');
                const y = [2024,2025,2026,2027,2028];
                document.getElementById('yearSelect').innerHTML = y.map(ym => `<option value="${ym}" ${ym===this.data.currentYear?'selected':''}>${ym}</option>`).join('');
            },
            
            handleImageUpload(e) {
                this.loadingManager.show('Processing image...');
                const f = e.target.files[0]; 
                if(!f) { this.loadingManager.hide(); return; }
                const r = new FileReader(); 
                r.readAsDataURL(f);
                r.onload = ev => {
                    const i = new Image(); 
                    i.src=ev.target.result;
                    i.onload=()=>{
                        const c = document.createElement('canvas');
                        const ctx=c.getContext('2d');
                        const mw=100; const sc=mw/i.width;
                        c.width=mw; c.height=i.height*sc;
                        ctx.drawImage(i,0,0,c.width,c.height);
                        document.getElementById('empPhotoBase64').value=c.toDataURL('image/jpeg',0.8);
                        document.getElementById('empPhotoPreview').src=c.toDataURL('image/jpeg',0.8);
                        this.loadingManager.hide();
                    };
                };
            },
            
            closeModals() { 
                document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active')); 
            },
            
            startClock() { 
                setInterval(() => document.getElementById('clock').innerText=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),1000); 
            },

            // --- System Logs ---
            renderLogs() {
                const tbody = document.getElementById('logsTableBody');
                const logs = JSON.parse(localStorage.getItem(CONFIG.storageKeys.logs) || '[]');
                if(logs.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color: #999;">No logs found.</td></tr>`;
                }
                tbody.innerHTML = logs.map(log => {
                    let typeClass = '';
                    if(log.type === 'error') typeClass = 'log-entry-error';
                    if(log.type === 'warn') typeClass = 'log-entry-warn';
                    else typeClass = 'log-entry-info';
                    
                    return `<tr class="${typeClass}">
                        <td style="font-size:11px; opacity:0.7;">${log.timestamp.split('T')[0]}</td>
                        <td style="font-size:12px; font-weight:600;">${log.type.toUpperCase()}</td>
                        <td>${log.message}</td>
                        <td style="font-size:11px;"><button class="btn btn-secondary" style="padding: 2px 6px;">Copy</button></td>
                    </tr>`;
                }).join('');
            },

            clearLogs() {
                localStorage.removeItem(CONFIG.storageKeys.logs);
                this.renderLogs();
                this.showToast('Logs Cleared', 'info');
                Logger.log('info', 'Logs cleared by user', 'LogManager');
            },

            openLogs() {
                this.renderLogs();
                document.getElementById('logsModal').classList.add('active');
            },

            openSystemInfo() {
                document.getElementById('infoModal').classList.add('active');
            },

            openBackupManager() {
                this.backupManager.renderBackupList();
                document.getElementById('backupModal').classList.add('active');
            },

            toggleSystemMenu() {
                document.getElementById('sysDropdown').classList.toggle('show');
            },

            downloadBackup() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data));
                const downloadAnchorNode = document.createElement("a");
                downloadAnchorNode.setAttribute("href", dataStr);
                const d = new Date();
                downloadAnchorNode.setAttribute("download", `HR_Master_Backup_v6.1_${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}.json`);
                document.body.appendChild(downloadAnchorNode); 
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                this.showToast('Backup downloaded successfully', 'success');
                Logger.log('info', 'Manual backup downloaded', 'BackupManager');
            },
            
            importCSV(input) {
                if(this.data.isLocked) return this.showToast('System Locked', 'error');
                
                this.loadingManager.show('Importing CSV...');
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const rows = text.split('\n').filter(row => row.trim() !== '');
                    if(rows.length < 2) {
                        this.showToast('Empty CSV', 'error');
                        this.loadingManager.hide();
                        return;
                    }
                    
                    const headers = rows[0].split(',').map(h => h.trim().toLowerCase());
                    const nameIdx = headers.indexOf('name');
                    const jobIdx = headers.indexOf('job number');
                    const phoneIdx = headers.indexOf('phone');
                    
                    if(nameIdx === -1) {
                        this.showToast('CSV must have "Name" column', 'error');
                        this.loadingManager.hide();
                        return;
                    }
                    
                    let addedCount = 0;
                    for(let i=1; i<rows.length; i++) {
                        const cols = rows[i].split(',').map(c => c.trim());
                        if(cols[nameIdx]) {
                            const newEmp = {
                                id: Date.now() + i,
                                name: cols[nameIdx],
                                jobNumber: cols[jobIdx] || '',
                                phone: cols[phoneIdx] || '',
                                nationality: '', passportNo: '', passportExp: '', eidNo: '', eidExp: '', joinDate: '', weeklyOff: '-1', photo: ''
                            };
                            this.data.employees.push(newEmp);
                            addedCount++;
                        }
                    }
                    this.saveData();
                    this.showToast(`Imported ${addedCount} Employees`, 'success');
                    Logger.log('info', `CSV import: ${addedCount} employees added`, 'ImportManager');
                    this.loadingManager.hide();
                    setTimeout(() => location.reload(), 1000);
                };
                reader.readAsText(file);
            },
            
            restoreBackup(input) {
                if(this.data.isLocked) return this.showToast('System Locked', 'error');
                
                this.loadingManager.show('Restoring backup...');
                const file = input.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if(json.employees && json.attendance && json.schedule) {
                            if(confirm('This will overwrite ALL current data. Are you sure?')) {
                                this.data = json;
                                this.saveData();
                                this.loadingManager.hide();
                                Logger.log('info', 'Backup restored successfully', 'BackupManager');
                                location.reload();
                            }
                        } else {
                            this.showToast('Invalid Backup File', 'error');
                            this.loadingManager.hide();
                        }
                    } catch(err) {
                        Logger.log('error', 'Backup restore failed', 'BackupManager');
                        ErrorHandler.show(err, 'Backup Restore');
                        this.loadingManager.hide();
                    }
                };
                reader.readAsText(file);
            },
            
            resetSystem() {
                if(confirm('WARNING: This will delete ALL Employees, Attendance, and Requests. This cannot be undone!')) {
                    if(confirm('Are you really sure?')) {
                        localStorage.clear();
                        Logger.log('warn', 'System reset by user', 'SystemManager');
                        location.reload();
                    }
                }
            },

            renderSummary() {
                const tbody = document.getElementById('summaryBody');
                const daysInMonth = new Date(this.data.currentYear, this.data.currentMonth + 1, 0).getDate();
                const t = CONFIG.translations[this.data.lang];

                const summaryRows = this.data.employees.map((emp, index) => {
                    let workingDays = 0, absentDays = 0, vacationDays = 0, sickDays = 0, overtimeHours = 0, overtimeDays = 0;
                    
                    for(let i=1; i<=daysInMonth; i++) {
                        const att = this.getAttendance(emp.id, i);
                        if(att) {
                            if(att.status === 'present' || att.status === 'overtime') {
                                workingDays++;
                                if(att.hours > 9) {
                                    overtimeHours += (att.hours - 9);
                                    overtimeDays++;
                                }
                            } else if (att.status === 'absent') {
                                absentDays++;
                            } else if (att.status === 'vacation') {
                                vacationDays++;
                            } else if (att.status === 'sick') {
                                sickDays++;
                            }
                        } else {
                            workingDays++;
                        }
                    }
                    
                    const totalDays = workingDays + absentDays + vacationDays + sickDays;
                    const totalOverTime = overtimeHours;
                    
                    return `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align:left; padding-${this.data.lang==='ar'?'right':'left'}:20px;">${emp.name}</td>
                        <td>${workingDays}</td>
                        <td style="background:#fee2e2;">${absentDays}</td>
                        <td style="background:#fef3c7;">${vacationDays}</td>
                        <td style="background:#ede9fe;">${sickDays}</td>
                        <td><strong>${totalDays}</strong></td>
                        <td style="color:#b45309;">${overtimeHours}</td>
                        <td>${overtimeDays}</td>
                        <td><strong>${totalOverTime}</strong></td>
                    </tr>`;
                }).join('');
                
                tbody.innerHTML = summaryRows || `<tr><td colspan="11" style="text-align:center;">${this.data.lang==='ar'?'لا يوجد موظفين':'No employees found. Add employees or Import CSV'}.</td></tr>`;
                
                this.createSummaryCharts();
            },
            
            createSummaryCharts() {
                // Destroy existing charts
                Object.values(this.charts).forEach(chart => chart.destroy());
                this.charts = {};
                
                const daysInMonth = new Date(this.data.currentYear, this.data.currentMonth + 1, 0).getDate();
                const summaryData = this.data.employees.map(emp => {
                    let workingDays = 0, absentDays = 0, vacationDays = 0, sickDays = 0;
                    let overtimeHours = 0;
                    
                    for (let i = 1; i <= daysInMonth; i++) {
                        const att = this.getAttendance(emp.id, i);
                        if (att) {
                            if (att.status === 'present' || att.status === 'overtime') {
                                workingDays++;
                                if (att.hours > 9) {
                                    overtimeHours += (att.hours - 9);
                                }
                            } else if (att.status === 'absent') {
                                absentDays++;
                            } else if (att.status === 'vacation') {
                                vacationDays++;
                            } else if (att.status === 'sick') {
                                sickDays++;
                            }
                        } else {
                            workingDays++;
                        }
                    }
                    
                    return {
                        name: emp.name,
                        workingDays,
                        absentDays,
                        vacationDays,
                        sickDays,
                        overtimeHours
                    };
                });
                
                const t = CONFIG.translations[this.data.lang];
                
                // Attendance Chart
                const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
                this.charts.attendance = new Chart(attendanceCtx, {
                    type: 'bar',
                    data: {
                        labels: summaryData.map(d => d.name),
                        datasets: [
                            {
                                label: t.col_work,
                                data: summaryData.map(d => d.workingDays),
                                backgroundColor: '#dcfce7',
                                borderColor: '#166534',
                                borderWidth:1
                            },
                            {
                                label: t.col_absent,
                                data: summaryData.map(d => d.absentDays),
                                backgroundColor: '#fee2e2',
                                borderColor: '#991b1b',
                                borderWidth: 1
                            },
                            {
                                label: t.col_vac,
                                data: summaryData.map(d => d.vacationDays),
                                backgroundColor: '#fef3c7',
                                borderColor: '#92400e',
                                borderWidth: 1
                            },
                            {
                                label: t.col_sick,
                                data: summaryData.map(d => d.sickDays),
                                backgroundColor: '#ede9fe',
                                borderColor: '#5b21b6',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: t.chart_title_att }
                        },
                        scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                    }
                });
                
                // Overtime Chart
                const overtimeCtx = document.getElementById('overtimeChart').getContext('2d');
                this.charts.overtime = new Chart(overtimeCtx, {
                    type: 'line',
                    data: {
                        labels: summaryData.map(d => d.name),
                        datasets: [{
                            label: t.col_ot_hours,
                            data: summaryData.map(d => d.overtimeHours),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: { display: true, text: t.chart_title_ot }
                        },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        };

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
